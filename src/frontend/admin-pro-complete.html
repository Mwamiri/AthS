<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AthSys Pro - Complete Athletics Management System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', 'Inter', sans-serif;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        :root {
            --primary: #ff6b35;
            --primary-dark: #d45528;
            --primary-light: #ff8c5a;
            --secondary: #06d6a0;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #27ae60;
            --info: #3498db;
        }

        [data-theme="dark"] { color-scheme: dark; }
        [data-theme="light"] { color-scheme: light; }

        * { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 53, 0.3); } 50% { box-shadow: 0 0 40px rgba(255, 107, 53, 0.6); } }
        
        .animate-slide-down { animation: slideDown 0.5s ease forwards; }
        .animate-slide-up { animation: slideUp 0.5s ease forwards; }
        .animate-fade-in { animation: fadeIn 0.5s ease; }

        .sidebar {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .sidebar-collapsed { width: 80px; }
        .sidebar-expanded { width: 280px; }

        .nav-item {
            position: relative;
            padding: 12px 16px;
            margin: 4px 12px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #cbd5e1;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 107, 53, 0.1);
            color: #ff6b35;
            border-left-color: #ff6b35;
            padding-left: 20px;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(255, 107, 53, 0.15) 0%, transparent 100%);
            color: #ff6b35;
            border-left-color: #ff6b35;
            font-weight: 600;
        }

        .nav-item i { font-size: 1.25rem; min-width: 20px; }

        .top-bar {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.90) 100%);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .top-bar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .card:hover::before {
            opacity: 1;
        }

        .dark .card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
            transform: translateY(-8px);
            animation: float 3s ease infinite;
        }

        .dark .card:hover {
            box-shadow: 0 12px 40px rgba(255, 107, 53, 0.15);
        }

        .stat-card { position: relative; overflow: hidden; }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b35, #ff8c5a);
        }

        .stat-card.success::before { background: linear-gradient(90deg, #06d6a0, #04a785); }
        .stat-card.warning::before { background: linear-gradient(90deg, #f39c12, #e67e22); }
        .stat-card.info::before { background: linear-gradient(90deg, #3498db, #2980b9); }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card .stat-icon { background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 107, 53, 0.05)); }
        .stat-card.success .stat-icon { background: linear-gradient(135deg, rgba(6, 214, 160, 0.1), rgba(6, 214, 160, 0.05)); }
        .stat-card.warning .stat-icon { background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(243, 156, 18, 0.05)); }
        .stat-card.info .stat-icon { background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05)); }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b35, #ff8c5a);
            color: white;
            padding: 10px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 40px rgba(255, 107, 53, 0.5);
        }

        .btn-primary:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn-secondary {
            background: rgba(6, 214, 160, 0.1);
            color: #06d6a0;
            padding: 10px 24px;
            border-radius: 10px;
            border: 2px solid #06d6a0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: rgba(6, 214, 160, 0.2);
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-danger {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            padding: 10px 24px;
            border-radius: 10px;
            border: 2px solid #e74c3c;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.2);
            transform: translateY(-2px);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success { background: rgba(6, 214, 160, 0.15); color: #06d6a0; }
        .badge-warning { background: rgba(243, 156, 18, 0.15); color: #f39c12; }
        .badge-danger { background: rgba(231, 76, 60, 0.15); color: #e74c3c; }
        .badge-info { background: rgba(52, 152, 219, 0.15); color: #3498db; }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .status-dot.online { background: #06d6a0; }
        .status-dot.offline { background: #e74c3c; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .table-modern {
            border-collapse: collapse;
            width: 100%;
        }

        .table-modern th {
            background: rgba(0, 0, 0, 0.02);
            font-weight: 600;
            color: #64748b;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dark .table-modern th {
            background: rgba(255, 255, 255, 0.02);
            color: #94a3b8;
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .table-modern td {
            padding: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .table-modern td {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        .table-modern tbody tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .dark .table-modern tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            animation: slideUp 0.3s ease;
        }

        .dark .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        .form-input {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .dark .form-input {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .notification-item {
            padding: 12px;
            border-left: 4px solid #ff6b35;
            background: rgba(255, 107, 53, 0.05);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .notification-item.read {
            border-left-color: #ccc;
            background: rgba(0, 0, 0, 0.02);
            opacity: 0.7;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in { animation: fadeIn 0.5s ease; }
        .animate-slide-up { animation: slideUp 0.5s ease; }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 16px 0;
        }

        .text-gradient {
            background: linear-gradient(135deg, #ff6b35, #ff8c5a);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .truncate-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        @media (max-width: 768px) {
            .sidebar-expanded {
                width: 100%;
                position: absolute;
                z-index: 50;
                height: 100%;
            }
            .nav-label { display: none; }

            .top-bar {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .table-modern th,
            .table-modern td {
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            .btn-primary,
            .btn-secondary,
            .btn-danger {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950">
    <div id="app">
        <!-- Loading Screen -->
        <div v-if="!appReady" class="flex items-center justify-center h-screen bg-gray-100 dark:bg-slate-950">
            <div class="text-center animate-fade-in">
                <div class="text-5xl mb-4"><i class="fas fa-running text-orange-500"></i></div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">AthSys Pro</h1>
                <p class="text-gray-600 dark:text-slate-300 text-base">Loading dashboard…</p>
                <div class="mt-8 flex justify-center gap-2">
                    <div class="w-3 h-3 bg-orange-500 rounded-full animate-pulse" style="animation-delay: 0s"></div>
                    <div class="w-3 h-3 bg-orange-500 rounded-full animate-pulse" style="animation-delay: 0.15s"></div>
                    <div class="w-3 h-3 bg-orange-500 rounded-full animate-pulse" style="animation-delay: 0.3s"></div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div v-show="appReady" class="flex h-screen bg-gray-50 dark:bg-slate-950 dark:text-white smooth-transition">
            
            <!-- Sidebar -->
            <aside class="sidebar smooth-transition flex flex-col" :class="[sidebarExpanded ? 'sidebar-expanded' : 'sidebar-collapsed']">
                <div class="p-4 border-b border-slate-700 flex items-center justify-between">
                    <div v-if="sidebarExpanded" class="flex items-center gap-3 flex-1">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white font-bold">
                            <i class="fas fa-running"></i>
                        </div>
                        <div>
                            <h1 class="text-sm font-bold text-white">AthSys</h1>
                            <p class="text-xs text-slate-400">Pro Admin</p>
                        </div>
                    </div>
                    <div v-else class="w-full text-center py-2">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white font-bold mx-auto">
                            <i class="fas fa-running text-sm"></i>
                        </div>
                    </div>
                    <button @click="sidebarExpanded = !sidebarExpanded" class="text-slate-400 hover:text-orange-400">
                        <i :class="sidebarExpanded ? 'fas fa-chevron-left' : 'fas fa-chevron-right'"></i>
                    </button>
                </div>

                <nav class="flex-1 overflow-y-auto p-2 space-y-1">
                    <div v-for="item in menuItems" :key="item.id"
                        @click="currentPage = item.id"
                        :class="['nav-item', { 'active': currentPage === item.id }]">
                        <i :class="['fas', item.icon, 'w-5']"></i>
                        <span v-if="sidebarExpanded" class="nav-label flex-1">{{ item.label }}</span>
                    </div>
                </nav>

                <div class="p-4 border-t border-slate-700 flex items-center gap-2">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-white font-bold text-sm">
                        <i class="fas fa-user"></i>
                    </div>
                    <div v-if="sidebarExpanded" class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-white truncate">{{ currentUser.name || 'Admin User' }}</p>
                        <p class="text-xs text-slate-400 truncate">{{ currentUser.roleLabel || 'Administrator' }}</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                
                <!-- Top Bar -->
                <header class="top-bar min-h-16 py-3 flex items-center justify-between px-4 sm:px-6 border-b border-gray-200 dark:border-slate-700 gap-3 flex-wrap">
                    <div class="flex items-center gap-4">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">{{ getPageTitle() }}</h2>
                        <div class="hidden md:flex items-center gap-2">
                            <span class="badge" :class="health.api_status === 'online' ? 'badge-success' : 'badge-danger'">
                                <span class="status-dot" :class="health.api_status === 'online' ? 'online' : 'offline'"></span>
                                API {{ health.api_status_label }}
                            </span>
                            <span class="badge" :class="health.db_status === 'online' ? 'badge-success' : 'badge-danger'">
                                <span class="status-dot" :class="health.db_status === 'online' ? 'online' : 'offline'"></span>
                                DB {{ health.db_status_label }}
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- Notifications Dropdown -->
                        <div class="relative">
                            <button @click="showNotifications = !showNotifications" class="relative p-2 text-gray-600 dark:text-slate-400 hover:text-orange-600">
                                <i class="fas fa-bell text-xl"></i>
                                <span v-if="notifications.filter(n => !n.read).length > 0" class="status-dot online absolute top-2 right-2 w-2 h-2"></span>
                            </button>
                            
                            <!-- Notifications Panel -->
                            <div v-if="showNotifications" class="absolute right-0 mt-2 w-80 bg-white dark:bg-slate-800 rounded-lg shadow-lg p-4 z-50">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-gray-900 dark:text-white">Notifications</h3>
                                    <button @click="clearNotifications" class="text-sm text-orange-600 hover:text-orange-700">Clear All</button>
                                </div>
                                <div v-if="notifications.length > 0" class="space-y-2 max-h-64 overflow-y-auto">
                                    <div v-for="notif in notifications" :key="notif.id" :class="['notification-item', { 'read': notif.read }]">
                                        <p class="font-semibold text-sm text-gray-900 dark:text-white">{{ notif.title }}</p>
                                        <p class="text-xs text-gray-600 dark:text-slate-400">{{ notif.message }}</p>
                                    </div>
                                </div>
                                <div v-else class="text-center text-gray-500 py-4">
                                    <p class="text-sm">✓ All caught up!</p>
                                </div>
                            </div>
                        </div>

                        <!-- Theme Toggle -->
                        <button @click="toggleTheme" class="p-2 text-gray-600 dark:text-slate-400 hover:text-orange-600">
                            <i :class="['fas text-xl', isDarkMode ? 'fa-sun' : 'fa-moon']"></i>
                        </button>

                        <!-- User Dropdown -->
                        <div class="relative">
                            <button @click="showUserMenu = !showUserMenu" class="flex items-center gap-2 p-2">
                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-white text-sm font-bold">
                                    A
                                </div>
                                <i class="fas fa-chevron-down text-sm text-gray-600 dark:text-slate-400"></i>
                            </button>
                            
                            <div v-if="showUserMenu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg overflow-hidden z-50">
                                <div class="p-4 border-b dark:border-slate-700">
                                    <p class="font-semibold text-gray-900 dark:text-white">Admin User</p>
                                    <p class="text-xs text-gray-600 dark:text-slate-400">Administrator</p>
                                </div>
                                <button @click="currentPage = 'settings'; showUserMenu = false" class="w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-2">
                                    <i class="fas fa-cog"></i> Settings
                                </button>
                                <button @click="currentPage = 'audit'; showUserMenu = false" class="w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-2">
                                    <i class="fas fa-file-alt"></i> Audit Logs
                                </button>
                                <button @click="currentPage = 'backups'; showUserMenu = false" class="w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-2">
                                    <i class="fas fa-save"></i> Backups
                                </button>
                                <div class="border-t dark:border-slate-700"></div>
                                <button @click="logout" class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 dark:hover:bg-slate-700 flex items-center gap-2">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Page Content -->
                <main class="flex-1 overflow-y-auto p-4 sm:p-6">
                    <!-- Dashboard Page -->
                    <div v-if="currentPage === 'dashboard'" class="space-y-6 animate-fade-in">
                        <!-- Welcome Card -->
                        <div class="card p-8 bg-gradient-to-br from-orange-50 to-red-50 dark:from-slate-800 dark:to-slate-900">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Welcome back, Admin!</h3>
                                    <p class="text-gray-600 dark:text-slate-400">Your athletics management system is running smoothly. Here's today's overview.</p>
                                </div>
                                <div class="text-5xl opacity-20"><i class="fas fa-chart-line"></i></div>
                            </div>
                        </div>

                        <!-- Statistics Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="card stat-card p-6">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 dark:text-slate-400 mb-2">Total Events</p>
                                        <h4 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">{{ stats.total_events }}</h4>
                                        <p class="text-xs text-green-600"><i class="fas fa-arrow-up"></i> {{ stats.active_competitions }} active</p>
                                    </div>
                                    <div class="stat-icon"><i class="fas fa-flag text-orange-600"></i></div>
                                </div>
                            </div>

                            <div class="card stat-card success p-6">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 dark:text-slate-400 mb-2">Active Athletes</p>
                                        <h4 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">{{ stats.total_athletes }}</h4>
                                        <p class="text-xs text-green-600"><i class="fas fa-arrow-up"></i> {{ stats.total_athletes_delta }}</p>
                                    </div>
                                    <div class="stat-icon"><i class="fas fa-person-running text-green-600"></i></div>
                                </div>
                            </div>

                            <div class="card stat-card warning p-6">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 dark:text-slate-400 mb-2">Registrations</p>
                                        <h4 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">{{ stats.total_results }}</h4>
                                        <p class="text-xs text-yellow-600"><i class="fas fa-arrow-right"></i> Results tracked</p>
                                    </div>
                                    <div class="stat-icon"><i class="fas fa-clipboard-list text-yellow-600"></i></div>
                                </div>
                            </div>

                            <div class="card stat-card info p-6">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 dark:text-slate-400 mb-2">System Status</p>
                                        <h4 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">{{ stats.system_status_label }}</h4>
                                        <p class="text-xs text-blue-600"><span class="status-dot online"></span> {{ stats.system_status }}</p>
                                    </div>
                                    <div class="stat-icon"><i class="fas fa-server text-blue-600"></i></div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="card p-6">
                                <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                    <i class="fas fa-chart-line text-orange-600"></i> Participation Trends
                                </h4>
                                <div class="chart-container">
                                    <canvas id="trendChart"></canvas>
                                </div>
                            </div>

                            <div class="card p-6">
                                <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                    <i class="fas fa-flag text-green-600"></i> Race Distribution
                                </h4>
                                <div class="chart-container">
                                    <canvas id="distributionChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="card p-6">
                            <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                <i class="fas fa-lightning-bolt text-yellow-600"></i> Quick Actions
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button @click="createRace" class="btn-primary">
                                    <i class="fas fa-plus"></i> New Race
                                </button>
                                <button @click="registerAthlete" class="btn-primary">
                                    <i class="fas fa-user-plus"></i> Register Athlete
                                </button>
                                <button @click="addUser" class="btn-primary">
                                    <i class="fas fa-users"></i> Add User
                                </button>
                                <button @click="currentPage = 'settings'" class="btn-secondary">
                                    <i class="fas fa-cog"></i> Settings
                                </button>
                            </div>
                        </div>

                        <!-- System Health -->
                        <div class="card p-6">
                            <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                <i class="fas fa-heartbeat text-red-600"></i> System Status
                            </h4>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="p-4 border rounded-lg dark:border-slate-700">
                                        <p class="text-sm text-gray-600 dark:text-slate-400 flex items-center gap-2 mb-2">
                                            <span :class="['status-dot', health.api_status === 'online' ? 'online' : 'offline']"></span> API Status
                                        </p>
                                        <p :class="['text-lg font-bold', health.api_status === 'online' ? 'text-green-600' : 'text-red-600']">● {{ health.api_status_label }}</p>
                                    </div>
                                    <div class="p-4 border rounded-lg dark:border-slate-700">
                                        <p class="text-sm text-gray-600 dark:text-slate-400 flex items-center gap-2 mb-2">
                                            <span :class="['status-dot', health.db_status === 'online' ? 'online' : 'offline']"></span> Database
                                        </p>
                                        <p :class="['text-lg font-bold', health.db_status === 'online' ? 'text-green-600' : 'text-red-600']">● {{ health.db_status_label }}</p>
                                    </div>
                                    <div class="p-4 border rounded-lg dark:border-slate-700">
                                        <p class="text-sm text-gray-600 dark:text-slate-400 mb-2 flex items-center gap-2">
                                            <i class="fas fa-sync"></i> Last Check
                                        </p>
                                        <p class="text-lg font-bold text-gray-900 dark:text-white">{{ health.last_checked }}</p>
                                    </div>
                                </div>
                                <button @click="refreshHealth" class="btn-secondary btn-small">
                                    <i class="fas fa-sync"></i> Check Health
                                </button>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="card p-6 lg:col-span-2">
                                <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                    <i class="fas fa-history text-blue-600"></i> Recent Activity
                                </h4>
                                <div class="space-y-3">
                                    <div v-for="activity in recentActivities" :key="activity.id" class="flex items-start gap-3 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 rounded-lg transition">
                                        <div class="text-green-600 mt-1">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-gray-900 dark:text-white">{{ activity.description }}</p>
                                            <p class="text-xs text-gray-500 dark:text-slate-400 mt-1">{{ activity.time }}</p>
                                        </div>
                                    </div>
                                </div>
                                <button @click="currentPage = 'audit'" class="text-orange-600 hover:text-orange-700 text-sm font-medium mt-4">View All →</button>
                            </div>

                            <div class="space-y-6">
                                <!-- Recent Races -->
                                <div class="card p-6">
                                    <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                        <i class="fas fa-flag text-orange-600"></i> Recent Races
                                    </h4>
                                    <div v-for="race in recentRaces.slice(0, 3)" :key="race.id" class="mb-3">
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ race.name }}</p>
                                        <p class="text-xs text-gray-600 dark:text-slate-400">{{ race.date }} • {{ race.location }}</p>
                                    </div>
                                    <button @click="currentPage = 'races'" class="text-orange-600 hover:text-orange-700 text-sm font-medium">View All →</button>
                                </div>

                                <!-- Recent Athletes -->
                                <div class="card p-6">
                                    <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                        <i class="fas fa-person-running text-green-600"></i> Recent Athletes
                                    </h4>
                                    <div v-for="athlete in recentAthletes.slice(0, 3)" :key="athlete.id" class="mb-3">
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ athlete.name }}</p>
                                        <p class="text-xs text-gray-600 dark:text-slate-400">{{ athlete.team }} • {{ athlete.event }}</p>
                                    </div>
                                    <button @click="currentPage = 'athletes'" class="text-orange-600 hover:text-orange-700 text-sm font-medium">View All →</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Races Management -->
                    <div v-if="currentPage === 'races'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Race Management</h3>
                                <button @click="createRace" class="btn-primary">
                                    <i class="fas fa-plus"></i> New Race
                                </button>
                            </div>
                            
                            <!-- Filters -->
                            <div class="mb-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg flex items-center gap-4">
                                <input v-model="filters.raceQuery" type="text" placeholder="Search races..." class="form-input flex-1" />
                                <select v-model="filters.raceStatus" class="form-input">
                                    <option>All Status</option>
                                    <option>Active</option>
                                    <option>Completed</option>
                                    <option>Upcoming</option>
                                </select>
                                <button @click="applyRaceFilters" class="btn-secondary btn-small">Apply Filters</button>
                            </div>

                            <!-- Table -->
                            <div class="overflow-x-auto">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Race Name</th>
                                            <th>Date</th>
                                            <th>Location</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="race in filteredRaces" :key="race.id">
                                            <td class="font-medium text-gray-900 dark:text-white">{{ race.name }}</td>
                                            <td>{{ race.date }}</td>
                                            <td>{{ race.location }}</td>
                                            <td>
                                                <span :class="['badge', race.status === 'active' ? 'badge-success' : race.status === 'completed' ? 'badge-info' : 'badge-warning']">
                                                    {{ race.status }}
                                                </span>
                                            </td>
                                            <td>
                                                <button @click="editRace(race)" class="text-orange-600 hover:text-orange-700 text-sm font-medium">Edit</button>
                                                <span class="text-gray-300"> • </span>
                                                <button @click="startRace(race)" class="text-green-600 hover:text-green-700 text-sm font-medium">Start</button>
                                                <span class="text-gray-300"> • </span>
                                                <button @click="stopRace(race)" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Stop</button>
                                                <span class="text-gray-300"> • </span>
                                                <button @click="deleteRace(race.id)" class="text-red-600 hover:text-red-700 text-sm font-medium">Delete</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Athletes Management -->
                    <div v-if="currentPage === 'athletes'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Athlete Management</h3>
                                <button @click="registerAthlete" class="btn-primary">
                                    <i class="fas fa-user-plus"></i> Register Athlete
                                </button>
                            </div>

                            <!-- Filters -->
                            <div class="mb-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg flex items-center gap-4">
                                <input v-model="filters.athleteQuery" type="text" placeholder="Search athletes..." class="form-input flex-1" />
                                <select v-model="filters.athleteStatus" class="form-input">
                                    <option>All Status</option>
                                    <option>Active</option>
                                    <option>Inactive</option>
                                </select>
                                <button @click="applyAthleteFilters" class="btn-secondary btn-small">Apply Filters</button>
                            </div>

                            <!-- Table -->
                            <div class="overflow-x-auto">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Team</th>
                                            <th>Event</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="athlete in filteredAthletes" :key="athlete.id">
                                            <td class="font-medium text-gray-900 dark:text-white">{{ athlete.name }}</td>
                                            <td>{{ athlete.team }}</td>
                                            <td>{{ athlete.event }}</td>
                                            <td>
                                                <span class="badge badge-success">{{ athlete.status }}</span>
                                            </td>
                                            <td>
                                                <button @click="editAthlete(athlete)" class="text-orange-600 hover:text-orange-700 text-sm font-medium">Edit</button>
                                                <span class="text-gray-300"> • </span>
                                                <button @click="deleteAthlete(athlete.id)" class="text-red-600 hover:text-red-700 text-sm font-medium">Delete</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Users Management -->
                    <div v-if="currentPage === 'users'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">User Management</h3>
                                <button @click="addUser" class="btn-primary w-full sm:w-auto">
                                    <i class="fas fa-user-plus"></i> Add User
                                </button>
                            </div>

                            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input v-model="userFilters.query" type="text" placeholder="Search name or email..." class="form-input w-full" />
                                <select v-model="userFilters.role" class="form-input w-full">
                                    <option value="all">All Roles</option>
                                    <option value="admin">Admin</option>
                                    <option value="chief_registrar">Chief Registrar</option>
                                    <option value="registrar">Registrar</option>
                                    <option value="starter">Starter</option>
                                    <option value="coach">Coach</option>
                                    <option value="official">Official</option>
                                    <option value="athlete">Athlete</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                                <select v-model="userFilters.status" class="form-input w-full">
                                    <option value="all">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>

                            <div class="md:hidden space-y-3">
                                <div v-for="user in filteredUsers" :key="`mobile-${user.id}`" class="p-4 border rounded-lg dark:border-slate-700 bg-white dark:bg-slate-900/50">
                                    <div class="flex items-start justify-between gap-3 mb-2">
                                        <div>
                                            <p class="font-semibold text-gray-900 dark:text-white">{{ user.name }}</p>
                                            <p class="text-sm text-gray-600 dark:text-slate-400 break-all">{{ user.email }}</p>
                                        </div>
                                        <span :class="['badge', user.status === 'active' ? 'badge-success' : 'badge-warning']">{{ user.status }}</span>
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-slate-400 mb-3">
                                        <p><span class="font-medium">Role:</span> {{ formatRole(user.role) }}</p>
                                        <p><span class="font-medium">Last Login:</span> {{ user.lastLogin || 'Never' }}</p>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <button @click="editUser(user)" class="btn-secondary btn-small w-auto"><i class="fas fa-pen"></i> Edit</button>
                                        <button @click="toggleUserStatus(user)" class="btn-secondary btn-small w-auto">
                                            <i class="fas" :class="user.status === 'active' ? 'fa-user-slash' : 'fa-user-check'"></i>
                                            {{ user.status === 'active' ? 'Suspend' : 'Activate' }}
                                        </button>
                                        <button @click="deleteUser(user.id)" class="btn-danger btn-small w-auto"><i class="fas fa-trash"></i> Delete</button>
                                    </div>
                                </div>
                                <div v-if="filteredUsers.length === 0" class="text-center text-gray-500 py-6 border rounded-lg dark:border-slate-700">No users found.</div>
                            </div>

                            <div class="hidden md:block overflow-x-auto">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="user in filteredUsers" :key="user.id">
                                            <td class="font-medium text-gray-900 dark:text-white">{{ user.name }}</td>
                                            <td class="text-gray-600 dark:text-slate-400">{{ user.email }}</td>
                                            <td>
                                                <span class="badge badge-info">{{ formatRole(user.role) }}</span>
                                            </td>
                                            <td>
                                                <span :class="['badge', user.status === 'active' ? 'badge-success' : 'badge-warning']">
                                                    {{ user.status }}
                                                </span>
                                            </td>
                                            <td class="text-sm text-gray-600 dark:text-slate-400">{{ user.lastLogin || 'Never' }}</td>
                                            <td>
                                                <button @click="editUser(user)" class="text-orange-600 hover:text-orange-700 text-sm font-medium">Edit</button>
                                                <span class="text-gray-300"> • </span>
                                                <button @click="toggleUserStatus(user)" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                                    {{ user.status === 'active' ? 'Suspend' : 'Activate' }}
                                                </button>
                                                <span class="text-gray-300"> • </span>
                                                <button @click="deleteUser(user.id)" class="text-red-600 hover:text-red-700 text-sm font-medium">Delete</button>
                                            </td>
                                        </tr>
                                        <tr v-if="filteredUsers.length === 0">
                                            <td colspan="6" class="text-center text-gray-500 py-6">No users found.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Results Management -->
                    <div v-if="currentPage === 'results'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Results Management</h3>
                                <div class="flex gap-2">
                                    <button @click="loadResults" class="btn-secondary btn-small">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                    <button @click="exportResultsCsv" class="btn-primary btn-small">
                                        <i class="fas fa-download"></i> Export CSV
                                    </button>
                                </div>
                            </div>

                            <div class="mb-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg flex items-center gap-4">
                                <input v-model="filters.resultsQuery" type="text" placeholder="Search results..." class="form-input flex-1" />
                                <select v-model="filters.resultsEvent" class="form-input">
                                    <option>All Events</option>
                                    <option>100m</option>
                                    <option>200m</option>
                                    <option>400m</option>
                                    <option>800m</option>
                                    <option>1500m</option>
                                    <option>Marathon</option>
                                </select>
                                <button @click="applyResultsFilters" class="btn-secondary btn-small">Apply Filters</button>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Athlete</th>
                                            <th>Event</th>
                                            <th>Time</th>
                                            <th>Position</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="result in filteredResults" :key="result.id">
                                            <td class="font-medium text-gray-900 dark:text-white">{{ result.athlete }}</td>
                                            <td>{{ result.event }}</td>
                                            <td>{{ result.time }}</td>
                                            <td>
                                                <span class="badge badge-info">#{{ result.position }}</span>
                                            </td>
                                        </tr>
                                        <tr v-if="filteredResults.length === 0">
                                            <td colspan="4" class="text-center text-gray-500 py-6">No results found.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Plugin Management -->
                    <div v-if="currentPage === 'plugins'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Plugin & Module Management</h3>
                                    <p class="text-sm text-gray-600 dark:text-slate-400 mt-1">WordPress/Joomla style module controls: enable or disable features safely.</p>
                                </div>
                                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                                    <button @click="bulkTogglePlugins('activate')" :disabled="!selectedPluginIds.length || isLoading.plugins" class="btn-secondary btn-small">
                                        <i class="fas fa-toggle-on"></i> Activate Selected
                                    </button>
                                    <button @click="bulkTogglePlugins('deactivate')" :disabled="!selectedPluginIds.length || isLoading.plugins" class="btn-secondary btn-small">
                                        <i class="fas fa-toggle-off"></i> Deactivate Selected
                                    </button>
                                    <button @click="loadPlugins" class="btn-secondary btn-small">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="p-4 rounded-lg border dark:border-slate-700 bg-white dark:bg-slate-900/50">
                                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-slate-400">Total Plugins</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ pluginStats.total_plugins || 0 }}</p>
                                </div>
                                <div class="p-4 rounded-lg border dark:border-slate-700 bg-white dark:bg-slate-900/50">
                                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-slate-400">Enabled</p>
                                    <p class="text-2xl font-bold text-green-600">{{ pluginStats.enabled_count || 0 }}</p>
                                </div>
                                <div class="p-4 rounded-lg border dark:border-slate-700 bg-white dark:bg-slate-900/50">
                                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-slate-400">Loaded In Memory</p>
                                    <p class="text-2xl font-bold text-blue-600">{{ pluginStats.loaded_count || 0 }}</p>
                                </div>
                            </div>

                            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input v-model="pluginSearch" type="text" placeholder="Search plugin name or module..." class="form-input w-full" />
                                <select v-model="pluginCategory" title="Filter plugins by category" class="form-input w-full">
                                    <option value="all">All Categories</option>
                                    <option v-for="category in pluginCategoryOptions" :key="`cat-${category}`" :value="category">{{ formatRole(category) }}</option>
                                </select>
                                <select v-model="pluginStatusFilter" title="Filter plugins by status" class="form-input w-full">
                                    <option value="all">All Status</option>
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                    <option value="blocked">Blocked</option>
                                </select>
                                <div class="flex items-center text-sm text-gray-600 dark:text-slate-400">
                                    <span>{{ filteredPlugins.length }} module(s) shown</span>
                                </div>
                            </div>

                            <div v-if="bulkActionReport" class="mb-6 p-4 rounded-lg border dark:border-slate-700 bg-gray-50 dark:bg-slate-900/40">
                                <div class="flex items-center justify-between gap-3 mb-2">
                                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white">
                                        Bulk {{ bulkActionReport.action }} Report
                                    </h4>
                                    <button @click="bulkActionReport = null" class="btn-secondary btn-small">Dismiss</button>
                                </div>
                                <p class="text-sm text-gray-700 dark:text-slate-300 mb-3">
                                    {{ bulkActionReport.updated_count }} updated · {{ bulkActionReport.blocked_count }} blocked · {{ bulkActionReport.failed_count }} failed
                                    <span class="text-xs text-gray-500 dark:text-slate-400">({{ bulkActionReport.timestamp }})</span>
                                </p>

                                <div v-if="bulkActionReport.blocked && bulkActionReport.blocked.length" class="mb-2">
                                    <p class="text-xs font-semibold uppercase tracking-wide text-amber-700 dark:text-amber-300 mb-1">Blocked</p>
                                    <ul class="text-xs text-amber-800 dark:text-amber-200 space-y-1">
                                        <li v-for="item in bulkActionReport.blocked.slice(0, 8)" :key="`blocked-${item.plugin_id}`">
                                            {{ item.plugin_id }} (depends in use by: {{ (item.blockers || []).join(', ') || 'dependency' }})
                                        </li>
                                    </ul>
                                </div>

                                <div v-if="bulkActionReport.failed && bulkActionReport.failed.length">
                                    <p class="text-xs font-semibold uppercase tracking-wide text-red-700 dark:text-red-300 mb-1">Failed</p>
                                    <ul class="text-xs text-red-800 dark:text-red-200 space-y-1">
                                        <li v-for="item in bulkActionReport.failed.slice(0, 8)" :key="`failed-${item.plugin_id}`">
                                            {{ item.plugin_id }} ({{ item.reason || 'failed' }})
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th class="w-10">
                                                <input type="checkbox" title="Select all visible plugins" :checked="allVisiblePluginsSelected" @change="toggleSelectAllPlugins($event.target.checked)" />
                                            </th>
                                            <th>Plugin</th>
                                            <th>Category / Module</th>
                                            <th>Version</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="plugin in filteredPlugins" :key="plugin.plugin_id || plugin.module || plugin.name">
                                            <td>
                                                <input
                                                    type="checkbox"
                                                    title="Select plugin"
                                                    :value="plugin.plugin_id"
                                                    :checked="selectedPluginIds.includes(plugin.plugin_id)"
                                                    @change="togglePluginSelection(plugin.plugin_id, $event.target.checked)"
                                                />
                                            </td>
                                            <td>
                                                <p class="font-semibold text-gray-900 dark:text-white">{{ plugin.name }}</p>
                                                <p class="text-xs text-gray-500 dark:text-slate-400">{{ plugin.description }}</p>
                                                <p v-if="plugin.disable_blockers && plugin.disable_blockers.length" class="text-xs text-amber-600 mt-1">
                                                    Depends in use by: {{ plugin.disable_blockers.join(', ') }}
                                                </p>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">{{ plugin.category_label || plugin.category || 'general' }}</span>
                                                <p class="text-xs text-gray-500 dark:text-slate-400 mt-1">{{ plugin.module || plugin.plugin_id || 'n/a' }}</p>
                                                <p v-if="plugin.plugin_id" class="text-xs text-gray-400 dark:text-slate-500">ID: {{ plugin.plugin_id }}</p>
                                            </td>
                                            <td>{{ plugin.version || 'n/a' }}</td>
                                            <td>
                                                <span :class="['badge', plugin.enabled ? 'badge-success' : 'badge-warning']">
                                                    {{ plugin.enabled ? 'enabled' : 'disabled' }}
                                                </span>
                                                <span v-if="plugin.required" class="badge badge-info ml-1">required</span>
                                            </td>
                                            <td>
                                                <button
                                                    @click="togglePlugin(plugin)"
                                                    :disabled="plugin.required || isLoading.plugins || pluginRowLoadingIds.includes(plugin.plugin_id)"
                                                    class="btn-secondary btn-small"
                                                >
                                                    <i
                                                        class="fas"
                                                        :class="pluginRowLoadingIds.includes(plugin.plugin_id)
                                                            ? 'fa-spinner fa-spin'
                                                            : (plugin.enabled ? 'fa-toggle-on' : 'fa-toggle-off')"
                                                    ></i>
                                                    {{ pluginRowLoadingIds.includes(plugin.plugin_id)
                                                        ? 'Working...'
                                                        : (plugin.enabled ? 'Deactivate' : 'Activate') }}
                                                </button>
                                            </td>
                                        </tr>
                                        <tr v-if="filteredPlugins.length === 0">
                                            <td colspan="6" class="text-center text-gray-500 py-6">No plugins found.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Subscription Manager -->
                    <div v-if="currentPage === 'subscriptions'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">SaaS Subscription Manager</h3>
                                    <p class="text-sm text-gray-600 dark:text-slate-400 mt-1">All SaaS operations in one place: clients, plans, subscriptions, and payments.</p>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button @click="createSaasClient" class="btn-primary btn-small">
                                        <i class="fas fa-building"></i> Register Client
                                    </button>
                                    <button @click="createSubscriptionCheckout" class="btn-secondary btn-small">
                                        <i class="fas fa-credit-card"></i> New Checkout
                                    </button>
                                    <button @click="loadSaasManager" class="btn-secondary btn-small">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                            </div>

                            <div class="mb-6 p-2 bg-gray-100 dark:bg-slate-900 rounded-lg inline-flex gap-2 flex-wrap">
                                <button @click="saasTab = 'clients'" :class="['px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap', saasTab === 'clients' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-slate-300']">Clients</button>
                                <button @click="saasTab = 'subscriptions'" :class="['px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap', saasTab === 'subscriptions' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-slate-300']">Subscriptions</button>
                                <button @click="saasTab = 'payments'" :class="['px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap', saasTab === 'payments' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-slate-300']">Payments</button>
                                <button @click="saasTab = 'plans'" :class="['px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap', saasTab === 'plans' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-slate-300']">Plans</button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="p-4 rounded-lg border dark:border-slate-700 bg-white dark:bg-slate-900/50">
                                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-slate-400">Clients</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ saasClients.length }}</p>
                                </div>
                                <div class="p-4 rounded-lg border dark:border-slate-700 bg-white dark:bg-slate-900/50">
                                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-slate-400">Subscriptions</p>
                                    <p class="text-2xl font-bold text-blue-600">{{ saasSubscriptions.length }}</p>
                                </div>
                                <div class="p-4 rounded-lg border dark:border-slate-700 bg-white dark:bg-slate-900/50">
                                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-slate-400">Active</p>
                                    <p class="text-2xl font-bold text-green-600">{{ saasSubscriptions.filter(item => item.status === 'active').length }}</p>
                                </div>
                                <div class="p-4 rounded-lg border dark:border-slate-700 bg-white dark:bg-slate-900/50">
                                    <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-slate-400">Payments (Pending)</p>
                                    <p class="text-2xl font-bold text-amber-600">{{ saasPayments.filter(item => item.status === 'pending').length }}</p>
                                </div>
                            </div>

                            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4" v-if="saasTab !== 'plans'">
                                <select v-model="saasFilters.subscriptionStatus" class="form-input w-full">
                                    <option value="all">All Subscription Status</option>
                                    <option value="pending_payment">Pending Payment</option>
                                    <option value="active">Active</option>
                                    <option value="paused">Paused</option>
                                    <option value="canceled">Canceled</option>
                                    <option value="expired">Expired</option>
                                </select>
                                <select v-model="saasFilters.paymentStatus" class="form-input w-full">
                                    <option value="all">All Payment Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                </select>
                                <select v-model="saasFilters.paymentMethod" class="form-input w-full">
                                    <option value="all">All Methods</option>
                                    <option v-for="method in saasPaymentMethods" :key="method.key" :value="method.key">{{ method.label }}</option>
                                </select>
                                <div class="flex items-center text-sm text-gray-600 dark:text-slate-400">
                                    <span v-if="saasTab === 'clients'">{{ saasClients.length }} client(s) shown</span>
                                    <span v-else-if="saasTab === 'subscriptions'">{{ filteredSaasSubscriptions.length }} subscription(s) shown</span>
                                    <span v-else>{{ filteredSaasPayments.length }} payment(s) shown</span>
                                </div>
                            </div>

                            <div v-if="saasTab === 'clients'" class="overflow-x-auto">
                                <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-3">Clients</h4>
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Company</th>
                                            <th>Contact</th>
                                            <th>Status</th>
                                            <th>Country</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="client in saasClients" :key="`client-${client.id}`">
                                            <td class="font-medium text-gray-900 dark:text-white">{{ client.company_name }}</td>
                                            <td>
                                                <div>{{ client.contact_name }}</div>
                                                <div class="text-xs text-gray-500 dark:text-slate-400">{{ client.email }}</div>
                                            </td>
                                            <td><span :class="['badge', client.status === 'active' ? 'badge-success' : 'badge-warning']">{{ client.status }}</span></td>
                                            <td>{{ client.country || '-' }}</td>
                                        </tr>
                                        <tr v-if="saasClients.length === 0">
                                            <td colspan="4" class="text-center text-gray-500 py-6">No clients found.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div v-if="saasTab === 'subscriptions'" class="overflow-x-auto">
                                    <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-3">Subscriptions</h4>
                                    <table class="table-modern">
                                        <thead>
                                            <tr>
                                                <th>Company</th>
                                                <th>Plan</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="subscription in filteredSaasSubscriptions" :key="`sub-${subscription.id}`">
                                                <td class="font-medium text-gray-900 dark:text-white">{{ subscription.company_name }}</td>
                                                <td>
                                                    <div>{{ subscription.plan_name }} ({{ subscription.billing_cycle }})</div>
                                                    <div class="text-xs text-gray-500 dark:text-slate-400">{{ subscription.currency }} {{ subscription.amount_due }}</div>
                                                </td>
                                                <td><span :class="['badge', subscription.status === 'active' ? 'badge-success' : subscription.status === 'pending_payment' ? 'badge-warning' : 'badge-info']">{{ subscription.status }}</span></td>
                                                <td>
                                                    <button @click="applySubscriptionAction(subscription, 'activate')" class="text-green-600 hover:text-green-700 text-sm font-medium">Activate</button>
                                                    <span class="text-gray-300"> • </span>
                                                    <button @click="applySubscriptionAction(subscription, 'pause')" class="text-amber-600 hover:text-amber-700 text-sm font-medium">Pause</button>
                                                    <span class="text-gray-300"> • </span>
                                                    <button @click="applySubscriptionAction(subscription, 'cancel')" class="text-red-600 hover:text-red-700 text-sm font-medium">Cancel</button>
                                                </td>
                                            </tr>
                                            <tr v-if="filteredSaasSubscriptions.length === 0">
                                                <td colspan="4" class="text-center text-gray-500 py-6">No subscriptions found.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                            </div>

                            <div v-if="saasTab === 'payments'" class="overflow-x-auto">
                                    <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-3">Payments</h4>
                                    <table class="table-modern">
                                        <thead>
                                            <tr>
                                                <th>Reference</th>
                                                <th>Method</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="payment in filteredSaasPayments" :key="`pay-${payment.id}`">
                                                <td class="font-medium text-gray-900 dark:text-white">{{ payment.reference }}</td>
                                                <td>{{ payment.payment_method }}</td>
                                                <td><span :class="['badge', payment.status === 'paid' ? 'badge-success' : 'badge-warning']">{{ payment.status }}</span></td>
                                                <td>
                                                    <button v-if="payment.status !== 'paid'" @click="confirmSubscriptionPayment(payment)" class="text-blue-600 hover:text-blue-700 text-sm font-medium">Confirm</button>
                                                    <span v-else class="text-gray-500 text-sm">Confirmed</span>
                                                </td>
                                            </tr>
                                            <tr v-if="filteredSaasPayments.length === 0">
                                                <td colspan="4" class="text-center text-gray-500 py-6">No payments found.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                            </div>

                            <div v-if="saasTab === 'plans'" class="overflow-x-auto">
                                <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-3">Plan Catalog</h4>
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Plan</th>
                                            <th>Monthly</th>
                                            <th>Trial</th>
                                            <th>Features</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="plan in saasPlans" :key="`plan-${plan.plan_key}`">
                                            <td class="font-medium text-gray-900 dark:text-white">{{ plan.name }}</td>
                                            <td>{{ plan.price_monthly == null ? 'Custom' : `${plan.currency || 'USD'} ${plan.price_monthly}` }}</td>
                                            <td>{{ plan.trial_days || 0 }} days</td>
                                            <td class="text-sm text-gray-600 dark:text-slate-400">{{ (plan.features || []).join(', ') }}</td>
                                        </tr>
                                        <tr v-if="saasPlans.length === 0">
                                            <td colspan="4" class="text-center text-gray-500 py-6">No plans found.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Logs -->
                    <div v-if="currentPage === 'audit'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Audit Logs</h3>

                            <!-- Filters -->
                            <div class="mb-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg flex items-center gap-4">
                                <select v-model="filters.auditAction" class="form-input">
                                    <option>All Actions</option>
                                    <option>CREATE</option>
                                    <option>UPDATE</option>
                                    <option>DELETE</option>
                                    <option>LOGIN</option>
                                    <option>LOGOUT</option>
                                </select>
                                <select v-model="filters.auditUser" class="form-input">
                                    <option>All Users</option>
                                    <option>Admin</option>
                                    <option>Coach</option>
                                </select>
                                <button @click="applyAuditFilters" class="btn-secondary btn-small">Apply Filters</button>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Resource</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="log in filteredAuditLogs" :key="log.id">
                                            <td class="text-sm">{{ log.timestamp }}</td>
                                            <td class="font-medium">{{ log.user }}</td>
                                            <td><span class="badge badge-info">{{ log.action }}</span></td>
                                            <td>{{ log.resource }}</td>
                                            <td class="text-gray-600 dark:text-slate-400 text-sm">{{ log.details }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Backups -->
                    <div v-if="currentPage === 'backups'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Backups</h3>
                                <button @click="createBackup" class="btn-primary btn-small">
                                    <i class="fas fa-database"></i> Create Backup
                                </button>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Backup ID</th>
                                            <th>Created</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="backup in backups" :key="backup.id">
                                            <td class="font-medium text-gray-900 dark:text-white">{{ backup.id }}</td>
                                            <td>{{ backup.created_at }}</td>
                                            <td>
                                                <span :class="['badge', backup.status === 'completed' ? 'badge-success' : 'badge-warning']">{{ backup.status }}</span>
                                            </td>
                                            <td>
                                                <button @click="downloadBackup(backup.id)" class="text-orange-600 hover:text-orange-700 text-sm font-medium">Download</button>
                                                <span class="text-gray-300"> • </span>
                                                <button @click="restoreBackup(backup.id)" class="text-red-600 hover:text-red-700 text-sm font-medium">Restore</button>
                                            </td>
                                        </tr>
                                        <tr v-if="backups.length === 0">
                                            <td colspan="4" class="text-center text-gray-500 py-6">No backups available.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- App Requests -->
                    <div v-if="currentPage === 'app-requests'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">App Build Requests</h3>
                            </div>

                            <!-- Filters -->
                            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Search</label>
                                        <input v-model="filters.appRequestQuery" type="text" placeholder="Search requests..." class="form-input w-full" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Status</label>
                                        <select v-model="filters.appRequestStatus" class="form-input w-full">
                                            <option>All Status</option>
                                            <option>Pending</option>
                                            <option>Approved</option>
                                            <option>Rejected</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div v-if="isLoading.appRequests" class="text-center py-8">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
                                <p class="mt-2 text-gray-600 dark:text-gray-400">Loading requests...</p>
                            </div>

                            <div v-else class="overflow-x-auto">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Requested By</th>
                                            <th>Priority</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="req in filteredAppRequests" :key="req.id">
                                            <td class="font-medium text-gray-900 dark:text-white">{{ req.title }}</td>
                                            <td class="text-sm text-gray-600 dark:text-gray-400">{{ req.requested_by }}</td>
                                            <td>
                                                <span :class="['badge', req.priority === 'high' ? 'badge-danger' : req.priority === 'medium' ? 'badge-warning' : 'badge-info']">
                                                    {{ req.priority }}
                                                </span>
                                            </td>
                                            <td>
                                                <span :class="['badge', req.status === 'approved' ? 'badge-success' : req.status === 'rejected' ? 'badge-danger' : 'badge-warning']">
                                                    {{ req.status }}
                                                </span>
                                            </td>
                                            <td class="text-sm text-gray-600 dark:text-gray-400">{{ req.created_at }}</td>
                                            <td>
                                                <button v-if="req.status === 'pending'" @click="approveAppRequest(req.id)" class="text-green-600 hover:text-green-700 text-sm font-medium">Approve</button>
                                                <button v-if="req.status === 'pending'" @click="rejectAppRequest(req.id)" class="text-red-600 hover:text-red-700 text-sm font-medium ml-3">Reject</button>
                                                <span v-else class="text-gray-500 text-sm">No actions</span>
                                            </td>
                                        </tr>
                                        <tr v-if="filteredAppRequests.length === 0">
                                            <td colspan="6" class="text-center text-gray-500 py-6">No app requests found.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Form Marking -->
                    <div v-if="currentPage === 'form-marking'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Form Submissions</h3>
                            </div>

                            <!-- Filters -->
                            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Search</label>
                                        <input v-model="filters.formSubmissionQuery" type="text" placeholder="Search submissions..." class="form-input w-full" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Status</label>
                                        <select v-model="filters.formSubmissionStatus" class="form-input w-full">
                                            <option>All Status</option>
                                            <option>Pending</option>
                                            <option>Approved</option>
                                            <option>Rejected</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div v-if="isLoading.formSubmissions" class="text-center py-8">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
                                <p class="mt-2 text-gray-600 dark:text-gray-400">Loading submissions...</p>
                            </div>

                            <div v-else class="overflow-x-auto">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th>Form Name</th>
                                            <th>Submitted By</th>
                                            <th>Submitted Date</th>
                                            <th>Status</th>
                                            <th>Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="form in filteredFormSubmissions" :key="form.id">
                                            <td class="font-medium text-gray-900 dark:text-white">{{ form.form_name }}</td>
                                            <td class="text-sm text-gray-600 dark:text-gray-400">{{ form.submitted_by }}</td>
                                            <td class="text-sm text-gray-600 dark:text-gray-400">{{ form.submitted_at }}</td>
                                            <td>
                                                <span :class="['badge', form.status === 'approved' ? 'badge-success' : form.status === 'rejected' ? 'badge-danger' : 'badge-warning']">
                                                    {{ form.status }}
                                                </span>
                                            </td>
                                            <td class="text-sm text-gray-600 dark:text-gray-400 max-w-xs truncate">{{ form.notes || '-' }}</td>
                                            <td>
                                                <button v-if="form.status === 'pending'" @click="approveFormSubmission(form.id)" class="text-green-600 hover:text-green-700 text-sm font-medium">Approve</button>
                                                <button v-if="form.status === 'pending'" @click="rejectFormSubmission(form.id)" class="text-red-600 hover:text-red-700 text-sm font-medium ml-3">Reject</button>
                                                <span v-else class="text-gray-500 text-sm">No actions</span>
                                            </td>
                                        </tr>
                                        <tr v-if="filteredFormSubmissions.length === 0">
                                            <td colspan="6" class="text-center text-gray-500 py-6">No form submissions found.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div v-if="currentPage === 'settings'" class="space-y-6 animate-fade-in">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">System Settings</h3>

                            <div class="mb-6 p-2 bg-gray-100 dark:bg-slate-900 rounded-lg inline-flex gap-2 flex-wrap">
                                <button @click="settingsTab = 'general'" :class="['px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap', settingsTab === 'general' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-slate-300']">General</button>
                                <button @click="settingsTab = 'theme'" :class="['px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap', settingsTab === 'theme' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-slate-300']">Theme Management</button>
                                <button @click="settingsTab = 'users'" :class="['px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap', settingsTab === 'users' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-slate-300']">User Management</button>
                                <button @click="settingsTab = 'compliance'" :class="['px-4 py-2 rounded-md text-sm font-semibold whitespace-nowrap', settingsTab === 'compliance' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow' : 'text-gray-600 dark:text-slate-300']">Compliance</button>
                            </div>

                            <div class="space-y-6">
                                <div v-if="settingsTab === 'general'" class="space-y-6">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">General</h4>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">System Name</label>
                                                <input v-model="settings.system_name" type="text" class="form-input w-full" />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Organization</label>
                                                <input v-model="settings.organization" type="text" class="form-input w-full" />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">SMTP Server</label>
                                                <input v-model="settings.smtp_server" type="text" class="form-input w-full" />
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">SMTP Port</label>
                                                <input v-model.number="settings.smtp_port" type="number" min="1" max="65535" class="form-input w-full" />
                                            </div>
                                            <button @click="saveSettings" class="btn-primary">
                                                <i class="fas fa-save"></i> Save General Settings
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="settingsTab === 'theme'" class="space-y-5">
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Theme Management</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Primary Color</label>
                                            <input v-model="settings.primary_color" type="color" class="form-input w-24 h-12" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Theme Mode</label>
                                            <select v-model="settings.theme_mode" class="form-input w-full">
                                                <option value="system">System Default</option>
                                                <option value="light">Light</option>
                                                <option value="dark">Dark</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Density</label>
                                            <select v-model="settings.density_mode" class="form-input w-full">
                                                <option value="compact">Compact</option>
                                                <option value="comfortable">Comfortable</option>
                                                <option value="spacious">Spacious</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="p-4 rounded-lg border border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900/40 space-y-4">
                                        <h5 class="text-sm font-semibold text-gray-900 dark:text-white">Canvas Studio (System Settings)</h5>
                                        <p class="text-sm text-gray-600 dark:text-slate-400">Launch visual builders directly from backend settings: application maker, form creation canvas, and improved theme maker.</p>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <a href="application-builder.html" class="btn-secondary btn-small flex items-center justify-center gap-2">
                                                <i class="fas fa-layer-group"></i> Canvas Application Maker
                                            </a>
                                            <a href="form-canvas.html" class="btn-secondary btn-small flex items-center justify-center gap-2">
                                                <i class="fas fa-pen-ruler"></i> Form Creation Canvas
                                            </a>
                                            <a href="theme-customizer.html" class="btn-secondary btn-small flex items-center justify-center gap-2">
                                                <i class="fas fa-palette"></i> Improved Theme Maker
                                            </a>
                                        </div>
                                    </div>
                                    <button @click="saveSettings" class="btn-primary">
                                        <i class="fas fa-paint-brush"></i> Save Theme Settings
                                    </button>
                                </div>

                                <div v-if="settingsTab === 'users'" class="space-y-5">
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">User Management Standards</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Password Minimum Length</label>
                                            <input v-model.number="settings.password_min_length" type="number" min="8" max="64" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Password Rotation (days)</label>
                                            <input v-model.number="settings.password_rotation_days" type="number" min="30" max="365" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Session Timeout (minutes)</label>
                                            <input v-model.number="settings.session_timeout_minutes" type="number" min="5" max="480" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Max Failed Logins</label>
                                            <input v-model.number="settings.max_failed_logins" type="number" min="3" max="20" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Auto-disable Inactive Accounts (days)</label>
                                            <input v-model.number="settings.auto_disable_inactive_days" type="number" min="30" max="365" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Access Review Frequency (days)</label>
                                            <input v-model.number="settings.access_review_frequency_days" type="number" min="30" max="365" class="form-input w-full" />
                                        </div>
                                    </div>
                                    <label class="inline-flex items-center gap-2 text-sm text-gray-700 dark:text-slate-300">
                                        <input v-model="settings.require_mfa_admin" type="checkbox" class="form-input w-4 h-4" />
                                        Require MFA for admin roles
                                    </label>
                                    <label class="inline-flex items-center gap-2 text-sm text-gray-700 dark:text-slate-300">
                                        <input v-model="settings.user_access_recertification_required" type="checkbox" class="form-input w-4 h-4" />
                                        Require formal user access recertification
                                    </label>
                                    <button @click="saveSettings" class="btn-primary">
                                        <i class="fas fa-users-cog"></i> Save User Management Policy
                                    </button>
                                </div>

                                <div v-if="settingsTab === 'compliance'" class="space-y-5">
                                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Compliance & ISO Readiness</h4>
                                    <div class="p-4 rounded-lg border border-amber-300 bg-amber-50 dark:bg-slate-900 dark:border-amber-500/40 text-sm text-amber-900 dark:text-amber-200">
                                        ISO certification cannot be self-declared in-app. This panel tracks readiness controls aligned to ISO/IEC 27001:2022.
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Framework</label>
                                            <input v-model="settings.iso_framework" type="text" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Readiness Level</label>
                                            <select v-model="settings.iso_readiness_level" class="form-input w-full">
                                                <option value="not_started">Not Started</option>
                                                <option value="in_progress">In Progress</option>
                                                <option value="internal_audit_ready">Internal Audit Ready</option>
                                                <option value="external_audit_ready">External Audit Ready</option>
                                                <option value="certified">Certified</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">ITIL4 Practice Maturity</label>
                                            <select v-model="settings.itil_practice_level" class="form-input w-full">
                                                <option value="initial">Initial</option>
                                                <option value="managed">Managed</option>
                                                <option value="defined">Defined</option>
                                                <option value="optimized">Optimized</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Audit Log Retention (days)</label>
                                            <input v-model.number="settings.audit_log_retention_days" type="number" min="90" max="3650" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">PII Data Retention (days)</label>
                                            <input v-model.number="settings.pii_data_retention_days" type="number" min="30" max="3650" class="form-input w-full" />
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Last Security Review Date</label>
                                            <input v-model="settings.security_review_last_date" type="date" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Incident SLA (hours)</label>
                                            <input v-model.number="settings.incident_sla_hours" type="number" min="1" max="168" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Service Request SLA (hours)</label>
                                            <input v-model.number="settings.service_request_sla_hours" type="number" min="1" max="720" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Major Incident Escalation (minutes)</label>
                                            <input v-model.number="settings.major_incident_escalation_minutes" type="number" min="5" max="240" class="form-input w-full" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Problem Review Cadence (days)</label>
                                            <input v-model.number="settings.problem_review_cadence_days" type="number" min="7" max="180" class="form-input w-full" />
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Service Desk Contact</label>
                                            <input v-model="settings.service_desk_contact" type="email" class="form-input w-full" />
                                        </div>
                                    </div>
                                    <label class="inline-flex items-center gap-2 text-sm text-gray-700 dark:text-slate-300">
                                        <input v-model="settings.change_approval_required" type="checkbox" class="form-input w-4 h-4" />
                                        Require formal change approval before production release
                                    </label>
                                    <button @click="saveSettings" class="btn-primary">
                                        <i class="fas fa-shield-alt"></i> Save Compliance Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </main>
            </div>
        </div>

        <!-- Success Message -->
        <div v-if="showSuccessMessage" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg animate-slide-up z-50">
            <i class="fas fa-check-circle mr-2"></i> {{ successMessage }}
        </div>

        <!-- Modal Form -->
        <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fade-in">
            <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md p-6 animate-slide-up">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                        {{ modalType === 'race' ? (editingId ? 'Edit Race' : 'Create New Race') : 
                           modalType === 'athlete' ? (editingId ? 'Edit Athlete' : 'Register Athlete') :
                           (editingId ? 'Edit User' : 'Add New User') }}
                    </h3>
                    <button @click="showModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Race Form -->
                    <div v-if="modalType === 'race'" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Race Name</label>
                            <input v-model="formData.name" type="text" placeholder="e.g., City Marathon" class="form-input w-full" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Date</label>
                            <input v-model="formData.date" type="date" class="form-input w-full" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Location</label>
                            <input v-model="formData.location" type="text" placeholder="e.g., Central Park" class="form-input w-full" />
                        </div>
                    </div>

                    <!-- Athlete Form -->
                    <div v-if="modalType === 'athlete'" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Full Name</label>
                            <input v-model="formData.name" type="text" placeholder="e.g., John Smith" class="form-input w-full" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Team</label>
                            <input v-model="formData.team" type="text" placeholder="e.g., Team A" class="form-input w-full" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Event</label>
                            <input v-model="formData.event" type="text" placeholder="e.g., 100m, 400m, Relay" class="form-input w-full" />
                        </div>
                    </div>

                    <!-- User Form -->
                    <div v-if="modalType === 'user'" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Full Name</label>
                            <input v-model="formData.name" type="text" placeholder="e.g., John Doe" class="form-input w-full" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Email</label>
                            <input v-model="formData.email" type="email" placeholder="e.g., john@example.com" class="form-input w-full" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Role</label>
                            <select v-model="formData.role" class="form-input w-full">
                                <option value="admin">Admin</option>
                                <option value="chief_registrar">Chief Registrar</option>
                                <option value="registrar">Registrar</option>
                                <option value="starter">Starter</option>
                                <option value="coach">Coach</option>
                                <option value="official">Official</option>
                                <option value="athlete">Athlete</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Status</label>
                            <select v-model="formData.status" class="form-input w-full">
                                <option value="active">active</option>
                                <option value="inactive">inactive</option>
                                <option value="suspended">suspended</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Temporary Password (optional)</label>
                            <input v-model="formData.password" type="password" placeholder="Only set when resetting credentials" class="form-input w-full" />
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex gap-3 pt-4 border-t dark:border-slate-700">
                        <button @click="modalType === 'race' ? saveRace() : modalType === 'athlete' ? saveAthlete() : saveUser()" class="btn-primary flex-1">
                            <i class="fas fa-save"></i> {{ editingId ? 'Update' : 'Create' }}
                        </button>
                        <button @click="showModal = false" class="btn-secondary flex-1">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="logout-helper.js"></script>
    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const appReady = ref(false);
                const currentPage = ref('dashboard');
                const sidebarExpanded = ref(true);
                const isDarkMode = ref(false);
                const showNotifications = ref(false);
                const showUserMenu = ref(false);
                const showModal = ref(false);
                const modalType = ref('');
                const editingId = ref(null);
                const showSuccessMessage = ref(false);
                const successMessage = ref('');
                const settingsTab = ref('general');

                const isLoading = ref({
                    races: false,
                    athletes: false,
                    users: false,
                    plugins: false,
                    saas: false,
                    results: false,
                    stats: false,
                    settings: false,
                    audit: false,
                    health: false,
                    backups: false,
                    appRequests: false,
                    formSubmissions: false
                });

                const errors = ref({
                    races: '',
                    athletes: '',
                    users: '',
                    plugins: '',
                    saas: '',
                    results: '',
                    stats: '',
                    settings: '',
                    audit: '',
                    health: '',
                    backups: '',
                    appRequests: '',
                    formSubmissions: ''
                });

                const menuItems = [
                    { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-line' },
                    { id: 'races', label: 'Races', icon: 'fa-flag' },
                    { id: 'athletes', label: 'Athletes', icon: 'fa-person-running' },
                    { id: 'results', label: 'Results', icon: 'fa-trophy' },
                    { id: 'subscriptions', label: 'SaaS Manager', icon: 'fa-layer-group' },
                    { id: 'users', label: 'Users', icon: 'fa-users' },
                    { id: 'plugins', label: 'Plugins', icon: 'fa-puzzle-piece' },
                    { id: 'audit', label: 'Audit Logs', icon: 'fa-file-alt' },
                    { id: 'app-requests', label: 'App Requests', icon: 'fa-code' },
                    { id: 'form-marking', label: 'Form Marking', icon: 'fa-check-square' },
                    { id: 'backups', label: 'Backups', icon: 'fa-database' },
                    { id: 'settings', label: 'Settings', icon: 'fa-cog' }
                ];

                const filters = ref({
                    raceQuery: '',
                    raceStatus: 'All Status',
                    athleteQuery: '',
                    athleteStatus: 'All Status',
                    auditAction: 'All Actions',
                    auditUser: 'All Users',
                    resultsQuery: '',
                    resultsEvent: 'All Events',
                    appRequestQuery: '',
                    appRequestStatus: 'All Status',
                    formSubmissionQuery: '',
                    formSubmissionStatus: 'All Status'
                });

                const formData = ref({
                    name: '', email: '', date: '', location: '', team: '', event: '', role: 'admin', status: 'active', password: ''
                });

                const stats = ref({
                    total_events: 0,
                    total_athletes: 0,
                    total_results: 0,
                    active_competitions: 0,
                    system_status: 'unknown',
                    system_status_label: '--',
                    total_athletes_delta: 'No trend'
                });

                const health = ref({
                    api_status: 'unknown',
                    api_status_label: 'Unknown',
                    db_status: 'unknown',
                    db_status_label: 'Unknown',
                    last_checked: '-'
                });

                const settings = ref({
                    system_name: 'AthSys - Athletics Management',
                    organization: 'Athletics Organization',
                    primary_color: '#ff6b35',
                    smtp_server: 'smtp.example.com',
                    smtp_port: 587,
                    theme_mode: 'system',
                    density_mode: 'comfortable',
                    password_min_length: 12,
                    password_rotation_days: 90,
                    session_timeout_minutes: 30,
                    max_failed_logins: 5,
                    require_mfa_admin: true,
                    auto_disable_inactive_days: 90,
                    access_review_frequency_days: 90,
                    user_access_recertification_required: true,
                    iso_framework: 'ISO/IEC 27001:2022',
                    iso_readiness_level: 'in_progress',
                    itil_practice_level: 'managed',
                    security_review_last_date: '',
                    audit_log_retention_days: 365,
                    pii_data_retention_days: 365,
                    incident_sla_hours: 8,
                    service_request_sla_hours: 24,
                    major_incident_escalation_minutes: 30,
                    problem_review_cadence_days: 30,
                    change_approval_required: true,
                    service_desk_contact: 'servicedesk@athsys.com'
                });

                const demoRaces = [
                    { id: 1, name: 'City Marathon 2026', date: 'Mar 15, 2026', location: 'Central Park', status: 'active' },
                    { id: 2, name: 'Sprint Championship', date: 'Apr 2, 2026', location: 'Olympic Stadium', status: 'upcoming' },
                    { id: 3, name: 'Relay Finals', date: 'May 10, 2026', location: 'Sports Complex', status: 'completed' }
                ];

                const demoAthletes = [
                    { id: 1, name: 'John Smith', team: 'Team A', event: '100m', status: 'active' },
                    { id: 2, name: 'Jane Doe', team: 'Team B', event: '400m', status: 'active' },
                    { id: 3, name: 'Mike Brown', team: 'Team C', event: 'Relay', status: 'active' }
                ];

                const demoResults = [
                    { id: 1, athlete: 'Eliud Kipchoge', event: 'Marathon', time: '2:01:39', position: 1 },
                    { id: 2, athlete: 'Faith Kipyegon', event: '1500m', time: '3:50.37', position: 1 },
                    { id: 3, athlete: 'Usain Bolt', event: '100m', time: '9.58', position: 1 }
                ];

                const recentRaces = ref([]);
                const recentAthletes = ref([]);
                const users = ref([]);
                const plugins = ref([]);
                const pluginStats = ref({
                    total_plugins: 0,
                    enabled_count: 0,
                    loaded_count: 0
                });
                const pluginSearch = ref('');
                const pluginCategory = ref('all');
                const pluginStatusFilter = ref('all');
                const selectedPluginIds = ref([]);
                const bulkActionReport = ref(null);
                const pluginRowLoadingIds = ref([]);
                const userFilters = ref({
                    query: '',
                    role: 'all',
                    status: 'all'
                });
                const results = ref([]);
                const backups = ref([]);
                const auditLogs = ref([]);
                const appRequests = ref([]);
                const formSubmissions = ref([]);
                const saasClients = ref([]);
                const saasSubscriptions = ref([]);
                const saasPayments = ref([]);
                const saasPlans = ref([]);
                const saasPaymentMethods = ref([]);
                const saasTab = ref('clients');
                const saasFilters = ref({
                    subscriptionStatus: 'all',
                    paymentStatus: 'all',
                    paymentMethod: 'all'
                });

                const notifications = ref([]);
                const recentActivities = ref([]);

                const currentUser = ref({
                    name: 'Admin User',
                    email: '',
                    role: 'admin',
                    roleLabel: 'Administrator'
                });

                const API_BASE = window.AthSysConfig?.apiBase || '/api';

                const getAuthToken = () => localStorage.getItem('authToken') || localStorage.getItem('token');
                const getRefreshToken = () => localStorage.getItem('refreshToken');

                const refreshAccessToken = async () => {
                    const refreshToken = getRefreshToken();
                    if (!refreshToken) {
                        return false;
                    }

                    try {
                        const response = await fetch(`${API_BASE}/auth/refresh`, {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ refresh_token: refreshToken })
                        });

                        if (!response.ok) {
                            return false;
                        }

                        const payload = await response.json();
                        const accessToken = payload?.access_token || payload?.token;
                        const nextRefreshToken = payload?.refresh_token || refreshToken;

                        if (!accessToken) {
                            return false;
                        }

                        localStorage.setItem('authToken', accessToken);
                        localStorage.setItem('refreshToken', nextRefreshToken);
                        return true;
                    } catch (error) {
                        return false;
                    }
                };

                const normalizeRole = (role) => (role || '').toString().trim().toLowerCase();

                const roleToLabel = (role) => {
                    const normalized = normalizeRole(role);
                    if (!normalized) return 'Administrator';
                    return normalized.split('_').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
                };

                const hydrateCurrentUser = () => {
                    const rawUser = localStorage.getItem('user');
                    if (!rawUser) return;

                    try {
                        const parsed = JSON.parse(rawUser);
                        const normalizedRole = normalizeRole(parsed?.role);
                        currentUser.value = {
                            name: parsed?.name || parsed?.email || 'Admin User',
                            email: parsed?.email || '',
                            role: normalizedRole || 'admin',
                            roleLabel: roleToLabel(normalizedRole)
                        };
                    } catch (error) {
                        currentUser.value = {
                            name: 'Admin User',
                            email: '',
                            role: 'admin',
                            roleLabel: 'Administrator'
                        };
                    }
                };

                const enforceAdminAccess = () => {
                    const token = getAuthToken();
                    if (!token) {
                        window.location.href = '/';
                        return false;
                    }

                    const rawUser = localStorage.getItem('user');
                    if (!rawUser) {
                        window.location.href = '/';
                        return false;
                    }

                    try {
                        const parsed = JSON.parse(rawUser);
                        const role = normalizeRole(parsed?.role);
                        const adminRoles = ['admin', 'chief_registrar'];
                        if (!adminRoles.includes(role)) {
                            window.location.href = '/athlete.html';
                            return false;
                        }
                    } catch (error) {
                        window.location.href = '/';
                        return false;
                    }

                    return true;
                };

                const apiRequest = async (path, options = {}, allowRetry = true) => {
                    const token = getAuthToken();
                    const headers = Object.assign(
                        { 'Accept': 'application/json' },
                        options.headers || {}
                    );

                    if (options.body && !headers['Content-Type']) {
                        headers['Content-Type'] = 'application/json';
                    }

                    if (token && !headers['Authorization']) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }

                    const response = await fetch(`${API_BASE}${path}`, { ...options, headers });
                    const contentType = response.headers.get('content-type') || '';
                    const payload = contentType.includes('application/json')
                        ? await response.json()
                        : await response.text();

                    if (response.status === 401 && allowRetry) {
                        const refreshed = await refreshAccessToken();
                        if (refreshed) {
                            return apiRequest(path, options, false);
                        }
                    }

                    if (!response.ok) {
                        const message = typeof payload === 'string'
                            ? payload
                            : (payload?.message || payload?.error || 'Request failed');
                        throw new Error(message);
                    }

                    return payload;
                };

                const extractList = (payload, keys) => {
                    if (Array.isArray(payload)) return payload;
                    if (!payload) return [];
                    for (const key of keys) {
                        if (Array.isArray(payload[key])) return payload[key];
                    }
                    return [];
                };

                const applyRaceFilters = () => showSuccess('Race filters applied');
                const applyAthleteFilters = () => showSuccess('Athlete filters applied');
                const applyAuditFilters = () => showSuccess('Audit filters applied');
                const applyResultsFilters = () => showSuccess('Results filters applied');

                const filteredRaces = computed(() => {
                    const query = filters.value.raceQuery.trim().toLowerCase();
                    const status = filters.value.raceStatus;
                    return recentRaces.value.filter(race => {
                        const matchesQuery = !query ||
                            [race.name, race.location, race.date].some(val => String(val || '').toLowerCase().includes(query));
                        const matchesStatus = status === 'All Status' || String(race.status || '').toLowerCase() === status.toLowerCase();
                        return matchesQuery && matchesStatus;
                    });
                });

                const filteredAthletes = computed(() => {
                    const query = filters.value.athleteQuery.trim().toLowerCase();
                    const status = filters.value.athleteStatus;
                    return recentAthletes.value.filter(athlete => {
                        const matchesQuery = !query ||
                            [athlete.name, athlete.team, athlete.event].some(val => String(val || '').toLowerCase().includes(query));
                        const matchesStatus = status === 'All Status' || String(athlete.status || '').toLowerCase() === status.toLowerCase();
                        return matchesQuery && matchesStatus;
                    });
                });

                const filteredAuditLogs = computed(() => {
                    const action = filters.value.auditAction;
                    const user = filters.value.auditUser;
                    return auditLogs.value.filter(log => {
                        const matchesAction = action === 'All Actions' || String(log.action || '').toUpperCase() === action;
                        const matchesUser = user === 'All Users' || String(log.user || '').toLowerCase().includes(user.toLowerCase());
                        return matchesAction && matchesUser;
                    });
                });

                const filteredResults = computed(() => {
                    const query = filters.value.resultsQuery.trim().toLowerCase();
                    const eventFilter = filters.value.resultsEvent;
                    return results.value.filter(result => {
                        const matchesQuery = !query ||
                            [result.athlete, result.event, result.time].some(val => String(val || '').toLowerCase().includes(query));
                        const matchesEvent = eventFilter === 'All Events' || String(result.event || '').toLowerCase() === eventFilter.toLowerCase();
                        return matchesQuery && matchesEvent;
                    });
                });

                const filteredUsers = computed(() => {
                    const query = (userFilters.value.query || '').toLowerCase().trim();
                    return users.value.filter(user => {
                        const roleMatch = userFilters.value.role === 'all' || String(user.role || '').toLowerCase() === userFilters.value.role;
                        const statusMatch = userFilters.value.status === 'all' || String(user.status || '').toLowerCase() === userFilters.value.status;
                        const queryMatch = !query || [user.name, user.email].some(value => String(value || '').toLowerCase().includes(query));
                        return roleMatch && statusMatch && queryMatch;
                    });
                });

                const filteredPlugins = computed(() => {
                    const query = (pluginSearch.value || '').toLowerCase().trim();
                    const category = String(pluginCategory.value || 'all').toLowerCase();
                    const status = String(pluginStatusFilter.value || 'all').toLowerCase();

                    return plugins.value.filter(plugin => {
                        const pluginCategoryValue = String(plugin.category || '').toLowerCase();
                        const matchesCategory = category === 'all' || pluginCategoryValue === category;
                        const isBlocked = Array.isArray(plugin.disable_blockers) && plugin.disable_blockers.length > 0;
                        const matchesStatus = status === 'all'
                            || (status === 'enabled' && !!plugin.enabled)
                            || (status === 'disabled' && !plugin.enabled)
                            || (status === 'blocked' && isBlocked);
                        const matchesQuery = !query || [plugin.name, plugin.description, plugin.module, plugin.plugin_id]
                            .some(value => String(value || '').toLowerCase().includes(query));
                        return matchesCategory && matchesStatus && matchesQuery;
                    });
                });

                const pluginCategoryOptions = computed(() => {
                    const categories = new Set(
                        plugins.value
                            .map(plugin => String(plugin.category || '').toLowerCase().trim())
                            .filter(Boolean)
                    );
                    return Array.from(categories).sort();
                });

                const allVisiblePluginsSelected = computed(() => {
                    if (!filteredPlugins.value.length) return false;
                    return filteredPlugins.value.every(plugin => selectedPluginIds.value.includes(plugin.plugin_id));
                });

                const filteredAppRequests = computed(() => {
                    const query = filters.value.appRequestQuery.trim().toLowerCase();
                    const status = filters.value.appRequestStatus;
                    return appRequests.value.filter(req => {
                        const matchesQuery = !query || [req.title, req.requested_by, req.description].some(val => String(val || '').toLowerCase().includes(query));
                        const matchesStatus = status === 'All Status' || (req.status || 'pending') === status.toLowerCase();
                        return matchesQuery && matchesStatus;
                    });
                });

                const filteredFormSubmissions = computed(() => {
                    const query = filters.value.formSubmissionQuery.trim().toLowerCase();
                    const status = filters.value.formSubmissionStatus;
                    return formSubmissions.value.filter(form => {
                        const matchesQuery = !query || [form.form_name, form.submitted_by].some(val => String(val || '').toLowerCase().includes(query));
                        const matchesStatus = status === 'All Status' || (form.status || 'pending') === status.toLowerCase();
                        return matchesQuery && matchesStatus;
                    });
                });

                const filteredSaasSubscriptions = computed(() => {
                    const status = String(saasFilters.value.subscriptionStatus || 'all').toLowerCase();
                    return saasSubscriptions.value.filter(item => {
                        return status === 'all' || String(item.status || '').toLowerCase() === status;
                    });
                });

                const filteredSaasPayments = computed(() => {
                    const status = String(saasFilters.value.paymentStatus || 'all').toLowerCase();
                    const method = String(saasFilters.value.paymentMethod || 'all').toLowerCase();
                    return saasPayments.value.filter(item => {
                        const matchesStatus = status === 'all' || String(item.status || '').toLowerCase() === status;
                        const matchesMethod = method === 'all' || String(item.payment_method || '').toLowerCase() === method;
                        return matchesStatus && matchesMethod;
                    });
                });

                const loadStats = async () => {
                    isLoading.value.stats = true;
                    errors.value.stats = '';
                    try {
                        const payload = await apiRequest('/stats');
                        stats.value = {
                            total_events: payload.total_events ?? 0,
                            total_athletes: payload.total_athletes ?? 0,
                            total_results: payload.total_results ?? 0,
                            active_competitions: payload.active_competitions ?? 0,
                            system_status: payload.system_status || 'operational',
                            system_status_label: payload.system_status ? payload.system_status.toUpperCase() : 'OK',
                            total_athletes_delta: payload.total_athletes_delta || 'Updated'
                        };
                    } catch (error) {
                        errors.value.stats = error.message;
                        stats.value = {
                            ...stats.value,
                            total_events: recentRaces.value.length,
                            total_athletes: recentAthletes.value.length,
                            total_results: results.value.length,
                            active_competitions: 0,
                            system_status: 'unknown',
                            system_status_label: 'N/A',
                            total_athletes_delta: 'Fallback'
                        };
                    } finally {
                        isLoading.value.stats = false;
                    }
                };

                const loadRaces = async () => {
                    isLoading.value.races = true;
                    errors.value.races = '';
                    try {
                        const payload = await apiRequest('/races');
                        const data = extractList(payload, ['races', 'data', 'items']);
                        recentRaces.value = data.length ? data : demoRaces;
                    } catch (error) {
                        errors.value.races = error.message;
                        recentRaces.value = demoRaces;
                    } finally {
                        isLoading.value.races = false;
                    }
                };

                const loadAthletes = async () => {
                    isLoading.value.athletes = true;
                    errors.value.athletes = '';
                    try {
                        const payload = await apiRequest('/athletes');
                        const data = extractList(payload, ['athletes', 'data', 'items']);
                        recentAthletes.value = data.length ? data : demoAthletes;
                    } catch (error) {
                        errors.value.athletes = error.message;
                        recentAthletes.value = demoAthletes;
                    } finally {
                        isLoading.value.athletes = false;
                    }
                };

                const loadUsers = async () => {
                    isLoading.value.users = true;
                    errors.value.users = '';
                    try {
                        const payload = await apiRequest('/admin/users');
                        users.value = extractList(payload, ['users', 'data', 'items']);
                    } catch (error) {
                        errors.value.users = error.message;
                    } finally {
                        isLoading.value.users = false;
                    }
                };

                const loadPlugins = async () => {
                    isLoading.value.plugins = true;
                    errors.value.plugins = '';
                    try {
                        const payload = await apiRequest('/admin/plugins');
                        plugins.value = extractList(payload, ['plugins', 'data', 'items']);
                        const visibleIds = new Set(plugins.value.map(p => p.plugin_id));
                        selectedPluginIds.value = selectedPluginIds.value.filter(id => visibleIds.has(id));
                        pluginStats.value = Object.assign({
                            total_plugins: plugins.value.length,
                            enabled_count: plugins.value.filter(p => p.enabled).length,
                            loaded_count: plugins.value.filter(p => p.is_loaded).length
                        }, payload?.stats || {});
                    } catch (error) {
                        errors.value.plugins = error.message;
                        plugins.value = [];
                        pluginStats.value = {
                            total_plugins: 0,
                            enabled_count: 0,
                            loaded_count: 0
                        };
                    } finally {
                        isLoading.value.plugins = false;
                    }
                };

                const togglePlugin = async (plugin) => {
                    if (!plugin || plugin.required || !plugin.plugin_id) return;

                    const actionLabel = plugin.enabled ? 'deactivate' : 'activate';
                    if (!confirm(`Do you want to ${actionLabel} "${plugin.name}"?`)) {
                        return;
                    }

                    let body = null;
                    if (plugin.enabled) {
                        const phrase = prompt('Type DEACTIVATE to confirm deactivation:');
                        if (phrase !== 'DEACTIVATE') {
                            showSuccess('Deactivation cancelled (confirmation phrase mismatch)');
                            return;
                        }
                        body = JSON.stringify({ confirmation_phrase: 'DEACTIVATE' });
                    }

                    const endpoint = plugin.enabled
                        ? `/admin/plugins/${plugin.plugin_id}/disable`
                        : `/admin/plugins/${plugin.plugin_id}/enable`;

                    try {
                        if (!pluginRowLoadingIds.value.includes(plugin.plugin_id)) {
                            pluginRowLoadingIds.value.push(plugin.plugin_id);
                        }
                        await apiRequest(endpoint, { method: 'POST', body });
                        showSuccess(`Plugin ${plugin.enabled ? 'deactivated' : 'activated'} successfully`);
                        await loadPlugins();
                    } catch (error) {
                        showSuccess(error.message || 'Plugin action failed');
                    } finally {
                        pluginRowLoadingIds.value = pluginRowLoadingIds.value.filter(id => id !== plugin.plugin_id);
                    }
                };

                const togglePluginSelection = (pluginId, checked) => {
                    if (!pluginId) return;
                    if (checked) {
                        if (!selectedPluginIds.value.includes(pluginId)) {
                            selectedPluginIds.value.push(pluginId);
                        }
                    } else {
                        selectedPluginIds.value = selectedPluginIds.value.filter(id => id !== pluginId);
                    }
                };

                const toggleSelectAllPlugins = (checked) => {
                    if (checked) {
                        const ids = filteredPlugins.value.map(p => p.plugin_id).filter(Boolean);
                        selectedPluginIds.value = Array.from(new Set([...selectedPluginIds.value, ...ids]));
                    } else {
                        const visible = new Set(filteredPlugins.value.map(p => p.plugin_id));
                        selectedPluginIds.value = selectedPluginIds.value.filter(id => !visible.has(id));
                    }
                };

                const bulkTogglePlugins = async (action) => {
                    const ids = selectedPluginIds.value.slice();
                    if (!ids.length) {
                        showSuccess('Select at least one plugin first');
                        return;
                    }

                    const actionLabel = action === 'deactivate' ? 'deactivate' : 'activate';
                    if (!confirm(`Do you want to ${actionLabel} ${ids.length} selected plugin(s)?`)) {
                        return;
                    }

                    const payload = {
                        action: actionLabel,
                        plugin_ids: ids
                    };

                    if (actionLabel === 'deactivate') {
                        const phrase = prompt('Type DEACTIVATE to confirm bulk deactivation:');
                        if (phrase !== 'DEACTIVATE') {
                            showSuccess('Bulk deactivation cancelled (confirmation phrase mismatch)');
                            return;
                        }
                        payload.confirmation_phrase = 'DEACTIVATE';
                    }

                    try {
                        const response = await apiRequest('/admin/plugins/bulk', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });

                        const summary = `${response.updated_count || 0} updated, ${response.blocked_count || 0} blocked, ${response.failed_count || 0} failed`;
                        const blockedDetails = Array.isArray(response.blocked)
                            ? response.blocked.map(item => {
                                const pluginId = item.plugin_id || 'unknown';
                                const blockers = Array.isArray(item.blockers) ? item.blockers.join(', ') : 'dependency'
                                return `${pluginId} (blocked by: ${blockers})`;
                            })
                            : [];
                        const failedDetails = Array.isArray(response.failed)
                            ? response.failed.map(item => `${item.plugin_id || 'unknown'} (${item.reason || 'failed'})`)
                            : [];

                        let feedback = `Bulk ${actionLabel} completed: ${summary}`;
                        if (blockedDetails.length) {
                            feedback += ` | Blocked: ${blockedDetails.slice(0, 3).join('; ')}`;
                        }
                        if (failedDetails.length) {
                            feedback += ` | Failed: ${failedDetails.slice(0, 3).join('; ')}`;
                        }

                        bulkActionReport.value = {
                            action: actionLabel,
                            updated_count: response.updated_count || 0,
                            blocked_count: response.blocked_count || 0,
                            failed_count: response.failed_count || 0,
                            blocked: Array.isArray(response.blocked) ? response.blocked : [],
                            failed: Array.isArray(response.failed) ? response.failed : [],
                            timestamp: new Date().toLocaleString()
                        };

                        showSuccess(feedback);
                        await loadPlugins();
                    } catch (error) {
                        showSuccess(error.message || 'Bulk plugin update failed');
                    }
                };

                const loadResults = async () => {
                    isLoading.value.results = true;
                    errors.value.results = '';
                    try {
                        const payload = await apiRequest('/results');
                        const data = extractList(payload, ['results', 'data', 'items']);
                        const mapped = data.map((item, index) => ({
                            id: item.id || index,
                            athlete: item.athlete || item.athlete_name || 'Unknown',
                            event: item.event || item.event_name || 'Event',
                            time: item.time || item.time_seconds || 'N/A',
                            position: item.position || item.rank || 0
                        }));
                        results.value = mapped.length ? mapped : demoResults;
                    } catch (error) {
                        errors.value.results = error.message;
                        results.value = demoResults;
                    } finally {
                        isLoading.value.results = false;
                    }
                };

                const loadAuditLogs = async () => {
                    isLoading.value.audit = true;
                    errors.value.audit = '';
                    try {
                        const payload = await apiRequest('/logs');
                        const logs = extractList(payload, ['logs', 'data', 'items']);
                        auditLogs.value = logs.map((log, index) => ({
                            id: log.id || index,
                            timestamp: log.timestamp || log.time || 'N/A',
                            user: log.user || log.user_email || 'System',
                            action: (log.action || log.level || 'INFO').toString().toUpperCase(),
                            resource: log.resource || log.resource_type || 'system',
                            details: log.details || log.message || ''
                        }));
                        recentActivities.value = auditLogs.value.slice(0, 4).map(log => ({
                            id: log.id,
                            description: `${log.action} ${log.resource}`.trim(),
                            time: log.timestamp
                        }));
                    } catch (error) {
                        errors.value.audit = error.message;
                    } finally {
                        isLoading.value.audit = false;
                    }
                };

                const loadSettings = async () => {
                    isLoading.value.settings = true;
                    errors.value.settings = '';
                    try {
                        const payload = await apiRequest('/settings');
                        if (payload?.settings) {
                            settings.value = Object.assign({}, settings.value, payload.settings);
                        }
                    } catch (error) {
                        errors.value.settings = error.message;
                    } finally {
                        isLoading.value.settings = false;
                    }
                };

                const saveSettings = async () => {
                    isLoading.value.settings = true;
                    errors.value.settings = '';
                    try {
                        await apiRequest('/settings', {
                            method: 'PUT',
                            body: JSON.stringify(settings.value)
                        });
                        showSuccess('Settings saved successfully');
                    } catch (error) {
                        errors.value.settings = error.message;
                        showSuccess('Failed to save settings');
                    } finally {
                        isLoading.value.settings = false;
                    }
                };

                const refreshHealth = async () => {
                    isLoading.value.health = true;
                    errors.value.health = '';
                    try {
                        const base = API_BASE.endsWith('/api') ? API_BASE.replace(/\/api$/, '') : API_BASE;
                        const response = await fetch(`${base}/health`);
                        health.value = {
                            api_status: response.ok ? 'online' : 'offline',
                            api_status_label: response.ok ? 'Online' : 'Offline',
                            db_status: response.ok ? 'online' : 'offline',
                            db_status_label: response.ok ? 'Connected' : 'Disconnected',
                            last_checked: new Date().toLocaleString()
                        };
                    } catch (error) {
                        errors.value.health = error.message;
                        health.value = {
                            api_status: 'offline',
                            api_status_label: 'Offline',
                            db_status: 'offline',
                            db_status_label: 'Disconnected',
                            last_checked: new Date().toLocaleString()
                        };
                    } finally {
                        isLoading.value.health = false;
                    }
                };

                const loadBackups = async () => {
                    isLoading.value.backups = true;
                    errors.value.backups = '';
                    try {
                        const payload = await apiRequest('/admin/backups');
                        backups.value = extractList(payload, ['backups', 'data', 'items']);
                    } catch (error) {
                        errors.value.backups = error.message;
                        backups.value = [];
                    } finally {
                        isLoading.value.backups = false;
                    }
                };

                const createBackup = async () => {
                    try {
                        await apiRequest('/admin/backups', { method: 'POST' });
                        showSuccess('Backup started');
                        await loadBackups();
                    } catch (error) {
                        showSuccess('Backup failed');
                    }
                };

                const downloadBackup = async (backupId) => {
                    try {
                        window.location.href = `${API_BASE}/admin/backups/${backupId}/download`;
                    } catch (error) {
                        showSuccess('Download failed');
                    }
                };

                const restoreBackup = async (backupId) => {
                    if (!confirm('Restore this backup?')) return;
                    try {
                        await apiRequest(`/admin/backups/${backupId}/restore`, { method: 'POST' });
                        showSuccess('Backup restored');
                    } catch (error) {
                        showSuccess('Restore failed');
                    }
                };

                const exportResultsCsv = () => {
                    if (!results.value.length) {
                        showSuccess('No results to export');
                        return;
                    }

                    const rows = [
                        ['Athlete', 'Event', 'Time', 'Position'],
                        ...results.value.map(r => [r.athlete, r.event, r.time, r.position])
                    ];

                    const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `results-${new Date().toISOString().slice(0, 10)}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);
                };

                const loadAppRequests = async () => {
                    isLoading.value.appRequests = true;
                    errors.value.appRequests = '';
                    try {
                        const payload = await apiRequest('/admin/app-requests');
                        appRequests.value = extractList(payload, ['requests', 'data', 'items']);
                        if (!appRequests.value.length) {
                            appRequests.value = [
                                { id: 1, title: 'School Events Tracker', requested_by: 'coach@school.edu', description: 'Track school-wide athletic events', priority: 'high', status: 'pending', created_at: '2024-01-15' },
                                { id: 2, title: 'Athlete Health Dashboard', requested_by: 'admin@athsys.com', description: 'Monitor athlete health metrics', priority: 'medium', status: 'approved', created_at: '2024-01-10', approved_by: 'admin@athsys.com', approved_at: '2024-01-12' }
                            ];
                        }
                    } catch (error) {
                        errors.value.appRequests = error.message;
                        appRequests.value = [
                            { id: 1, title: 'School Events Tracker', requested_by: 'coach@school.edu', description: 'Track school-wide athletic events', priority: 'high', status: 'pending', created_at: '2024-01-15' },
                            { id: 2, title: 'Athlete Health Dashboard', requested_by: 'admin@athsys.com', description: 'Monitor athlete health metrics', priority: 'medium', status: 'approved', created_at: '2024-01-10', approved_by: 'admin@athsys.com', approved_at: '2024-01-12' }
                        ];
                    } finally {
                        isLoading.value.appRequests = false;
                    }
                };

                const loadFormSubmissions = async () => {
                    isLoading.value.formSubmissions = true;
                    errors.value.formSubmissions = '';
                    try {
                        const payload = await apiRequest('/admin/form-submissions');
                        formSubmissions.value = extractList(payload, ['submissions', 'data', 'items']);
                        if (!formSubmissions.value.length) {
                            formSubmissions.value = [
                                { id: 1, form_name: 'Athlete Registration', submitted_by: 'athlete@example.com', submitted_at: '2024-01-20', status: 'pending', notes: '' },
                                { id: 2, form_name: 'Event Participation', submitted_by: 'coach@school.edu', submitted_at: '2024-01-18', status: 'approved', notes: 'Approved - all documents verified' }
                            ];
                        }
                    } catch (error) {
                        errors.value.formSubmissions = error.message;
                        formSubmissions.value = [
                            { id: 1, form_name: 'Athlete Registration', submitted_by: 'athlete@example.com', submitted_at: '2024-01-20', status: 'pending', notes: '' },
                            { id: 2, form_name: 'Event Participation', submitted_by: 'coach@school.edu', submitted_at: '2024-01-18', status: 'approved', notes: 'Approved - all documents verified' }
                        ];
                    } finally {
                        isLoading.value.formSubmissions = false;
                    }
                };

                const loadSaasManager = async () => {
                    isLoading.value.saas = true;
                    errors.value.saas = '';
                    try {
                        const [clientsPayload, subscriptionsPayload, paymentsPayload, plansPayload] = await Promise.all([
                            apiRequest('/admin/clients'),
                            apiRequest('/admin/subscriptions'),
                            apiRequest('/admin/payments'),
                            apiRequest('/saas/plans')
                        ]);

                        saasClients.value = extractList(clientsPayload, ['clients', 'data', 'items']);
                        saasSubscriptions.value = extractList(subscriptionsPayload, ['subscriptions', 'data', 'items']);
                        saasPayments.value = extractList(paymentsPayload, ['payments', 'data', 'items']);
                        saasPlans.value = extractList(plansPayload, ['plans', 'data', 'items']);
                        saasPaymentMethods.value = extractList(plansPayload, ['payment_methods'])
                            .concat(extractList(paymentsPayload, ['payment_methods']));

                        if (!saasPaymentMethods.value.length) {
                            saasPaymentMethods.value = [
                                { key: 'paypal', label: 'PayPal' },
                                { key: 'visa', label: 'Visa / Card' },
                                { key: 'mpesa', label: 'M-Pesa' }
                            ];
                        }
                    } catch (error) {
                        errors.value.saas = error.message;
                        showSuccess(error.message || 'Failed to load SaaS manager data');
                    } finally {
                        isLoading.value.saas = false;
                    }
                };

                const createSaasClient = async () => {
                    const companyName = prompt('Company name');
                    if (!companyName) return;
                    const contactName = prompt('Contact person');
                    if (!contactName) return;
                    const email = prompt('Contact email');
                    if (!email) return;

                    try {
                        await apiRequest('/saas/clients/register', {
                            method: 'POST',
                            body: JSON.stringify({
                                company_name: companyName,
                                contact_name: contactName,
                                email
                            })
                        });
                        showSuccess('Client registered successfully');
                        await loadSaasManager();
                        saasTab.value = 'clients';
                    } catch (error) {
                        showSuccess(error.message || 'Client registration failed');
                    }
                };

                const createSubscriptionCheckout = async () => {
                    if (!saasClients.value.length) {
                        showSuccess('Register a client first');
                        return;
                    }

                    const clientId = Number(prompt(`Client ID (${saasClients.value.map(c => `${c.id}:${c.company_name}`).join(', ')})`));
                    if (!clientId) return;
                    const planKey = prompt('Plan key (starter/professional/enterprise)', 'professional');
                    if (!planKey) return;
                    const paymentMethod = prompt('Payment method (paypal/visa/mpesa)', 'paypal');
                    if (!paymentMethod) return;

                    try {
                        await apiRequest('/saas/subscriptions/checkout', {
                            method: 'POST',
                            body: JSON.stringify({
                                client_id: clientId,
                                plan_key: planKey,
                                payment_method: paymentMethod,
                                billing_cycle: 'monthly'
                            })
                        });
                        showSuccess('Subscription checkout created');
                        await loadSaasManager();
                        saasTab.value = 'subscriptions';
                    } catch (error) {
                        showSuccess(error.message || 'Checkout failed');
                    }
                };

                const applySubscriptionAction = async (subscription, action) => {
                    if (!subscription?.id) return;
                    try {
                        await apiRequest(`/admin/subscriptions/${subscription.id}/action`, {
                            method: 'POST',
                            body: JSON.stringify({ action })
                        });
                        showSuccess(`Subscription ${action} action applied`);
                        await loadSaasManager();
                    } catch (error) {
                        showSuccess(error.message || 'Subscription action failed');
                    }
                };

                const confirmSubscriptionPayment = async (payment) => {
                    if (!payment?.reference) return;
                    try {
                        await apiRequest('/saas/payments/confirm', {
                            method: 'POST',
                            body: JSON.stringify({ reference: payment.reference })
                        });
                        showSuccess('Payment confirmed successfully');
                        await loadSaasManager();
                    } catch (error) {
                        showSuccess(error.message || 'Payment confirmation failed');
                    }
                };

                const approveAppRequest = async (requestId) => {
                    try {
                        await apiRequest(`/admin/app-requests/${requestId}/approve`, {
                            method: 'PUT',
                            body: JSON.stringify({ approved_by: 'admin@athsys.com' })
                        });
                        showSuccess('✅ App request approved');
                        await loadAppRequests();
                    } catch (error) {
                        showSuccess('❌ Failed to approve request');
                    }
                };

                const rejectAppRequest = async (requestId) => {
                    const reason = prompt('Enter rejection reason:');
                    if (!reason) return;
                    try {
                        await apiRequest(`/admin/app-requests/${requestId}/reject`, {
                            method: 'PUT',
                            body: JSON.stringify({ rejected_reason: reason })
                        });
                        showSuccess('✅ App request rejected');
                        await loadAppRequests();
                    } catch (error) {
                        showSuccess('❌ Failed to reject request');
                    }
                };

                const approveFormSubmission = async (submissionId) => {
                    const notes = prompt('Enter approval notes:');
                    if (!notes) return;
                    try {
                        await apiRequest(`/admin/form-submissions/${submissionId}/approve`, {
                            method: 'PUT',
                            body: JSON.stringify({ notes })
                        });
                        showSuccess('✅ Form submission approved');
                        await loadFormSubmissions();
                    } catch (error) {
                        showSuccess('❌ Failed to approve submission');
                    }
                };

                const rejectFormSubmission = async (submissionId) => {
                    const notes = prompt('Enter rejection notes:');
                    if (!notes) return;
                    try {
                        await apiRequest(`/admin/form-submissions/${submissionId}/reject`, {
                            method: 'PUT',
                            body: JSON.stringify({ notes })
                        });
                        showSuccess('✅ Form submission rejected');
                        await loadFormSubmissions();
                    } catch (error) {
                        showSuccess('❌ Failed to reject submission');
                    }
                };

                // ===== RACE METHODS =====
                const createRace = () => {
                    formData.value = { name: '', date: '', location: '', email: '', team: '', event: '', role: 'Admin' };
                    editingId.value = null;
                    modalType.value = 'race';
                    showModal.value = true;
                };

                const editRace = (race) => {
                    formData.value = { ...race };
                    editingId.value = race.id;
                    modalType.value = 'race';
                    showModal.value = true;
                };

                const deleteRace = async (id) => {
                    if (!confirm('Are you sure you want to delete this race?')) return;
                    try {
                        await apiRequest(`/races/${id}`, { method: 'DELETE' });
                        recentRaces.value = recentRaces.value.filter(r => r.id !== id);
                        showSuccess('Race deleted successfully');
                    } catch (error) {
                        showSuccess('Delete failed');
                    }
                };

                const saveRace = async () => {
                    try {
                        if (editingId.value) {
                            const payload = await apiRequest(`/races/${editingId.value}`, {
                                method: 'PUT',
                                body: JSON.stringify(formData.value)
                            });
                            const idx = recentRaces.value.findIndex(r => r.id === editingId.value);
                            const updated = payload?.race || payload;
                            if (idx >= 0) recentRaces.value[idx] = { ...recentRaces.value[idx], ...updated };
                            showSuccess('Race updated successfully');
                        } else {
                            const payload = await apiRequest('/races', {
                                method: 'POST',
                                body: JSON.stringify(formData.value)
                            });
                            const created = payload?.race || payload;
                            if (created) recentRaces.value.unshift(created);
                            showSuccess('Race created successfully');
                        }
                    } catch (error) {
                        showSuccess('Save failed');
                    } finally {
                        showModal.value = false;
                    }
                };

                const startRace = async (race) => {
                    if (!race?.id) return;
                    if (!confirm(`Send START signal for "${race.name}"?`)) return;
                    try {
                        await apiRequest(`/races/${race.id}/start`, { method: 'POST' });
                        showSuccess('Race started successfully');
                        await loadRaces();
                    } catch (error) {
                        showSuccess(error.message || 'Failed to start race');
                    }
                };

                const stopRace = async (race) => {
                    if (!race?.id) return;
                    if (!confirm(`Send STOP signal for "${race.name}"?`)) return;
                    try {
                        await apiRequest(`/races/${race.id}/stop`, { method: 'POST' });
                        showSuccess('Race stopped successfully');
                        await loadRaces();
                    } catch (error) {
                        showSuccess(error.message || 'Failed to stop race');
                    }
                };

                // ===== ATHLETE METHODS =====
                const registerAthlete = () => {
                    formData.value = { name: '', team: '', event: '', email: '', date: '', location: '', role: 'Admin' };
                    editingId.value = null;
                    modalType.value = 'athlete';
                    showModal.value = true;
                };

                const editAthlete = (athlete) => {
                    formData.value = { ...athlete };
                    editingId.value = athlete.id;
                    modalType.value = 'athlete';
                    showModal.value = true;
                };

                const deleteAthlete = async (id) => {
                    if (!confirm('Are you sure you want to delete this athlete?')) return;
                    try {
                        await apiRequest(`/athletes/${id}`, { method: 'DELETE' });
                        recentAthletes.value = recentAthletes.value.filter(a => a.id !== id);
                        showSuccess('Athlete deleted successfully');
                    } catch (error) {
                        showSuccess('Delete failed');
                    }
                };

                const saveAthlete = async () => {
                    try {
                        if (editingId.value) {
                            const payload = await apiRequest(`/athletes/${editingId.value}`, {
                                method: 'PUT',
                                body: JSON.stringify(formData.value)
                            });
                            const idx = recentAthletes.value.findIndex(a => a.id === editingId.value);
                            const updated = payload?.athlete || payload;
                            if (idx >= 0) recentAthletes.value[idx] = { ...recentAthletes.value[idx], ...updated };
                            showSuccess('Athlete updated successfully');
                        } else {
                            const payload = await apiRequest('/athletes', {
                                method: 'POST',
                                body: JSON.stringify(formData.value)
                            });
                            const created = payload?.athlete || payload;
                            if (created) recentAthletes.value.unshift(created);
                            showSuccess('Athlete registered successfully');
                        }
                    } catch (error) {
                        showSuccess('Save failed');
                    } finally {
                        showModal.value = false;
                    }
                };

                // ===== USER METHODS =====
                const addUser = () => {
                    formData.value = { name: '', email: '', role: 'admin', status: 'active', password: '', date: '', location: '', team: '', event: '' };
                    editingId.value = null;
                    modalType.value = 'user';
                    showModal.value = true;
                };

                const editUser = (user) => {
                    formData.value = { ...user, role: String(user.role || '').toLowerCase(), status: String(user.status || 'active').toLowerCase(), password: '' };
                    editingId.value = user.id;
                    modalType.value = 'user';
                    showModal.value = true;
                };

                const deleteUser = async (id) => {
                    if (!confirm('Are you sure you want to delete this user?')) return;
                    try {
                        await apiRequest(`/admin/users/${id}`, { method: 'DELETE' });
                        users.value = users.value.filter(u => u.id !== id);
                        showSuccess('User deleted successfully');
                    } catch (error) {
                        showSuccess('Delete failed');
                    }
                };

                const saveUser = async () => {
                    try {
                        const userPayload = {
                            name: formData.value.name,
                            email: formData.value.email,
                            role: formData.value.role,
                            status: formData.value.status
                        };

                        if (formData.value.password) {
                            userPayload.password = formData.value.password;
                        }

                        if (editingId.value) {
                            const payload = await apiRequest(`/admin/users/${editingId.value}`, {
                                method: 'PUT',
                                body: JSON.stringify(userPayload)
                            });
                            const idx = users.value.findIndex(u => u.id === editingId.value);
                            const updated = payload?.user || payload;
                            if (idx >= 0) users.value[idx] = { ...users.value[idx], ...updated };
                            showSuccess('User updated successfully');
                        } else {
                            const payload = await apiRequest('/admin/users', {
                                method: 'POST',
                                body: JSON.stringify(userPayload)
                            });
                            const created = payload?.user || payload;
                            if (created) users.value.unshift(created);
                            showSuccess('User created successfully');
                        }
                    } catch (error) {
                        showSuccess('Save failed');
                    } finally {
                        showModal.value = false;
                    }
                };

                const toggleUserStatus = async (user) => {
                    const nextStatus = user.status === 'active' ? 'suspended' : 'active';
                    try {
                        const payload = await apiRequest(`/admin/users/${user.id}`, {
                            method: 'PUT',
                            body: JSON.stringify({ status: nextStatus })
                        });
                        const updated = payload?.user || payload;
                        const idx = users.value.findIndex(item => item.id === user.id);
                        if (idx >= 0) {
                            users.value[idx] = { ...users.value[idx], ...updated };
                        }
                        showSuccess(`User ${nextStatus === 'active' ? 'activated' : 'suspended'} successfully`);
                    } catch (error) {
                        showSuccess('Status update failed');
                    }
                };

                const formatRole = (role) => {
                    const raw = String(role || '');
                    if (!raw) return 'Unknown';
                    return raw.replace(/_/g, ' ').replace(/\b\w/g, (ch) => ch.toUpperCase());
                };

                const getPageTitle = () => {
                    const page = menuItems.find(item => item.id === currentPage.value);
                    return page ? page.label : 'Dashboard';
                };

                const toggleTheme = () => {
                    isDarkMode.value = !isDarkMode.value;
                    document.documentElement.setAttribute('data-theme', isDarkMode.value ? 'dark' : 'light');
                };

                const clearNotifications = () => {
                    notifications.value.forEach(n => n.read = true);
                    notifications.value = [];
                };

                const logout = async () => {
                    return logoutWithRevocation({
                        redirectTo: '/',
                        confirmMessage: 'Are you sure you want to logout?'
                    });
                };

                const showSuccess = (msg) => {
                    successMessage.value = msg;
                    showSuccessMessage.value = true;
                    setTimeout(() => { showSuccessMessage.value = false; }, 3000);
                };

                let trendChart = null;
                let distChart = null;

                const updateCharts = () => {
                    const trendCtx = document.getElementById('trendChart');
                    const distCtx = document.getElementById('distributionChart');

                    const trendLabels = ['Athletes', 'Events', 'Results', 'Active'];
                    const trendValues = [
                        stats.value.total_athletes,
                        stats.value.total_events,
                        stats.value.total_results,
                        stats.value.active_competitions
                    ];

                    const distribution = results.value.reduce((acc, item) => {
                        const key = item.event || 'Other';
                        acc[key] = (acc[key] || 0) + 1;
                        return acc;
                    }, {});

                    const distLabels = Object.keys(distribution).length ? Object.keys(distribution) : ['No Data'];
                    const distValues = Object.keys(distribution).length ? Object.values(distribution) : [1];

                    if (trendCtx) {
                        if (trendChart) {
                            trendChart.data.labels = trendLabels;
                            trendChart.data.datasets[0].data = trendValues;
                            trendChart.update();
                        } else {
                            trendChart = new Chart(trendCtx, {
                                type: 'line',
                                data: {
                                    labels: trendLabels,
                                    datasets: [{
                                        label: 'Participation',
                                        data: trendValues,
                                        borderColor: '#ff6b35',
                                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                                        tension: 0.4,
                                        fill: true,
                                        pointRadius: 5,
                                        pointBackgroundColor: '#ff6b35',
                                        pointBorderColor: 'white',
                                        pointBorderWidth: 2
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: { y: { beginAtZero: true } }
                                }
                            });
                        }
                    }

                    if (distCtx) {
                        if (distChart) {
                            distChart.data.labels = distLabels;
                            distChart.data.datasets[0].data = distValues;
                            distChart.update();
                        } else {
                            distChart = new Chart(distCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: distLabels,
                                    datasets: [{
                                        data: distValues,
                                        backgroundColor: ['#ff6b35', '#06d6a0', '#f39c12', '#3498db', '#9b59b6'],
                                        borderColor: 'white',
                                        borderWidth: 3
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: true, position: 'bottom' } }
                                }
                            });
                        }
                    }
                };

                const initializeApp = async () => {
                    if (!enforceAdminAccess()) {
                        return;
                    }

                    hydrateCurrentUser();

                    const minDelay = new Promise(resolve => setTimeout(resolve, 800));
                    await Promise.all([
                        loadStats(),
                        loadRaces(),
                        loadAthletes(),
                        loadUsers(),
                        loadPlugins(),
                        loadSaasManager(),
                        loadResults(),
                        loadSettings(),
                        loadAuditLogs(),
                        refreshHealth(),
                        loadBackups(),
                        loadAppRequests(),
                        loadFormSubmissions(),
                        minDelay
                    ]);
                    appReady.value = true;
                    setTimeout(updateCharts, 300);
                };

                initializeApp();

                return {
                    appReady,
                    currentPage,
                    sidebarExpanded,
                    isDarkMode,
                    settingsTab,
                    showNotifications,
                    showUserMenu,
                    showModal,
                    modalType,
                    formData,
                    showSuccessMessage,
                    successMessage,
                    menuItems,
                    filters,
                    stats,
                    health,
                    settings,
                    recentRaces,
                    recentAthletes,
                    users,
                    plugins,
                    pluginStats,
                    pluginSearch,
                    pluginCategory,
                    pluginStatusFilter,
                    selectedPluginIds,
                    bulkActionReport,
                    pluginRowLoadingIds,
                    userFilters,
                    results,
                    backups,
                    notifications,
                    currentUser,
                    recentActivities,
                    auditLogs,
                    filteredRaces,
                    filteredAthletes,
                    filteredAuditLogs,
                    filteredResults,
                    filteredUsers,
                    filteredPlugins,
                    pluginCategoryOptions,
                    allVisiblePluginsSelected,
                    applyRaceFilters,
                    applyAthleteFilters,
                    applyAuditFilters,
                    applyResultsFilters,
                    loadResults,
                    exportResultsCsv,
                    appRequests,
                    formSubmissions,
                    saasTab,
                    saasFilters,
                    saasClients,
                    saasSubscriptions,
                    saasPayments,
                    saasPlans,
                    saasPaymentMethods,
                    filteredAppRequests,
                    filteredFormSubmissions,
                    filteredSaasSubscriptions,
                    filteredSaasPayments,
                    loadAppRequests,
                    loadFormSubmissions,
                    loadSaasManager,
                    createSaasClient,
                    createSubscriptionCheckout,
                    applySubscriptionAction,
                    confirmSubscriptionPayment,
                    approveAppRequest,
                    rejectAppRequest,
                    approveFormSubmission,
                    rejectFormSubmission,
                    createRace,
                    editRace,
                    deleteRace,
                    saveRace,
                    startRace,
                    stopRace,
                    registerAthlete,
                    editAthlete,
                    deleteAthlete,
                    saveAthlete,
                    addUser,
                    editUser,
                    deleteUser,
                    saveUser,
                    toggleUserStatus,
                    loadPlugins,
                    togglePlugin,
                    togglePluginSelection,
                    toggleSelectAllPlugins,
                    bulkTogglePlugins,
                    formatRole,
                    createBackup,
                    downloadBackup,
                    restoreBackup,
                    getPageTitle,
                    toggleTheme,
                    clearNotifications,
                    refreshHealth,
                    saveSettings,
                    logout
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
